<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Platform Architecture â€“ Sapiant</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap');
  :root {
    --bg:#0a0e1a;--surface:#111827;--surface2:#1a2235;--border:#1e2d45;--border-bright:#2a3f5e;
    --accent:#00c4ff;--accent2:#7c3aed;--accent3:#10b981;--accent4:#f59e0b;--accent5:#ef4444;
    --text:#e2e8f0;--text-muted:#64748b;--text-dim:#94a3b8;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{background:var(--bg);color:var(--text);font-family:'IBM Plex Sans',sans-serif;min-height:100vh;overflow-x:hidden;}
  body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,196,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,196,255,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
  .container{position:relative;z-index:1;max-width:1400px;margin:0 auto;padding:40px 32px;}
  header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:48px;padding-bottom:32px;border-bottom:1px solid var(--border);}
  .header-left h1{font-size:13px;font-weight:600;letter-spacing:0.2em;text-transform:uppercase;color:var(--accent);font-family:'IBM Plex Mono',monospace;margin-bottom:10px;}
  .header-left h2{font-size:32px;font-weight:700;line-height:1.1;}
  .header-left h2 span{color:var(--accent);}
  .header-left p{margin-top:10px;color:var(--text-dim);font-size:15px;max-width:480px;line-height:1.6;}
  .header-meta{text-align:right;font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--text-muted);line-height:2;}
  .tabs{display:flex;gap:4px;margin-bottom:32px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:4px;width:fit-content;flex-wrap:wrap;}
  .tab{padding:8px 16px;border-radius:7px;font-size:13px;font-weight:500;cursor:pointer;transition:all 0.2s;color:var(--text-muted);border:none;background:transparent;font-family:'IBM Plex Sans',sans-serif;}
  .tab:hover{color:var(--text);background:var(--surface2);}
  .tab.active{background:var(--accent);color:#0a0e1a;font-weight:600;}
  .panel{display:none;animation:fadeIn 0.3s ease;}
  .panel.active{display:block;}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
  /* ARCH */
  .arch-diagram{display:grid;gap:16px;}
  .tier{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px 24px;transition:border-color 0.2s;}
  .tier:hover{border-color:var(--border-bright);}
  .tier-label{font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:0.15em;text-transform:uppercase;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px;}
  .tier-label::after{content:'';flex:1;height:1px;background:var(--border);}
  .tier-label.client{color:var(--accent);}.tier-label.identity{color:var(--accent2);}.tier-label.gateway{color:var(--accent4);}.tier-label.backend{color:var(--accent3);}.tier-label.data{color:#f472b6;}.tier-label.powerbi{color:var(--accent);}
  .tier-row{display:flex;gap:12px;flex-wrap:wrap;align-items:stretch;}
  .box{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px 16px;flex:1;min-width:160px;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;}
  .box::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;transition:opacity 0.2s;opacity:0;}
  .box:hover{border-color:var(--border-bright);transform:translateY(-1px);}
  .box:hover::before{opacity:1;}
  .box.accent-blue::before{background:var(--accent);}.box.accent-purple::before{background:var(--accent2);}.box.accent-green::before{background:var(--accent3);}.box.accent-amber::before{background:var(--accent4);}.box.accent-pink::before{background:#f472b6;}
  .box:hover.accent-blue{border-color:var(--accent);}.box:hover.accent-purple{border-color:var(--accent2);}.box:hover.accent-green{border-color:var(--accent3);}.box:hover.accent-amber{border-color:var(--accent4);}
  .box-icon{font-size:20px;margin-bottom:8px;}.box-title{font-size:13px;font-weight:600;color:var(--text);margin-bottom:4px;}.box-sub{font-size:11px;color:var(--text-muted);line-height:1.4;}
  .flow-arrows{display:flex;justify-content:center;align-items:center;padding:4px 0;gap:32px;color:var(--text-muted);font-size:11px;font-family:'IBM Plex Mono',monospace;}
  .arrow-item{display:flex;align-items:center;gap:6px;flex-direction:column;}
  .arrow-line{width:1px;height:24px;background:linear-gradient(to bottom,var(--border),transparent);position:relative;}
  .arrow-line::after{content:'â–¼';position:absolute;bottom:-6px;left:50%;transform:translateX(-50%);font-size:8px;color:var(--border-bright);}
  .legend{display:flex;gap:20px;flex-wrap:wrap;margin-top:16px;padding-top:16px;border-top:1px solid var(--border);}
  .legend-item{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-muted);font-family:'IBM Plex Mono',monospace;}
  .legend-dot{width:8px;height:8px;border-radius:2px;}
  .hint{display:inline-block;font-size:11px;color:var(--text-muted);border:1px solid var(--border);border-radius:4px;padding:2px 8px;font-family:'IBM Plex Mono',monospace;margin-bottom:16px;}
  /* DETAIL */
  .detail-panel{position:fixed;right:0;top:0;bottom:0;width:380px;background:var(--surface);border-left:1px solid var(--border);padding:32px 28px;transform:translateX(100%);transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);z-index:100;overflow-y:auto;}
  .detail-panel.open{transform:translateX(0);}
  .detail-close{position:absolute;top:20px;right:20px;background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);border-radius:6px;padding:6px 12px;cursor:pointer;font-size:12px;font-family:'IBM Plex Mono',monospace;transition:all 0.2s;}
  .detail-close:hover{border-color:var(--accent5);color:var(--accent5);}
  .detail-tag{font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:0.15em;text-transform:uppercase;color:var(--accent);margin-bottom:8px;}
  .detail-title{font-size:20px;font-weight:700;margin-bottom:16px;}
  .detail-desc{font-size:14px;color:var(--text-dim);line-height:1.7;margin-bottom:20px;}
  .detail-section{margin-bottom:20px;}
  .detail-section-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-muted);margin-bottom:10px;font-family:'IBM Plex Mono',monospace;}
  .detail-item{display:flex;gap:10px;margin-bottom:8px;align-items:flex-start;}
  .detail-item-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);margin-top:6px;flex-shrink:0;}
  .detail-item-text{font-size:13px;color:var(--text-dim);line-height:1.5;}
  .detail-tech{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;}
  .tech-badge{font-family:'IBM Plex Mono',monospace;font-size:11px;padding:3px 10px;border-radius:4px;background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);}
  .tech-badge.primary{border-color:var(--accent);color:var(--accent);background:rgba(0,196,255,0.06);}
  .tech-badge.purple{border-color:var(--accent2);color:var(--accent2);background:rgba(124,58,237,0.06);}
  .tech-badge.green{border-color:var(--accent3);color:var(--accent3);background:rgba(16,185,129,0.06);}
  .tech-badge.amber{border-color:var(--accent4);color:var(--accent4);background:rgba(245,158,11,0.06);}
  .backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99;}
  .backdrop.open{display:block;}
  /* RLS */
  .rls-flow{display:grid;gap:0;margin-bottom:24px;}
  .rls-step{display:grid;grid-template-columns:40px 1fr;gap:16px;align-items:flex-start;padding:16px 8px;border-bottom:1px solid var(--border);transition:background 0.2s;border-radius:6px;}
  .rls-step:hover{background:var(--surface2);}
  .rls-step:last-child{border-bottom:none;}
  .rls-num{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:600;flex-shrink:0;}
  .rls-step-content h4{font-size:13px;font-weight:600;margin-bottom:4px;}
  .rls-step-content p{font-size:12px;color:var(--text-muted);line-height:1.5;}
  .rls-step-content code{font-family:'IBM Plex Mono',monospace;font-size:11px;background:var(--surface2);border:1px solid var(--border);padding:2px 6px;border-radius:3px;color:var(--accent3);display:inline-block;margin-top:4px;}
  /* TRADEOFFS */
  .tradeoff-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
  .tradeoff-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px;}
  .tradeoff-header{display:flex;align-items:center;gap:10px;margin-bottom:14px;}
  .tradeoff-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;}
  .tradeoff-title{font-size:14px;font-weight:600;}.tradeoff-subtitle{font-size:11px;color:var(--text-muted);}
  .tradeoff-body{font-size:13px;color:var(--text-dim);line-height:1.6;}
  .pro-con{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px;}
  .pro,.con{background:var(--surface2);border-radius:6px;padding:10px 12px;}
  .pro{border-top:2px solid var(--accent3);}.con{border-top:2px solid var(--accent5);}
  .pro-title,.con-title{font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;margin-bottom:6px;}
  .pro-title{color:var(--accent3);}.con-title{color:var(--accent5);}
  .pro li,.con li{font-size:11px;color:var(--text-muted);margin-bottom:3px;list-style:none;padding-left:12px;position:relative;line-height:1.4;}
  .pro li::before{content:'+';position:absolute;left:0;color:var(--accent3);}
  .con li::before{content:'âˆ’';position:absolute;left:0;color:var(--accent5);}
  /* SCALABILITY */
  .scale-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
  .scale-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:20px;}
  .scale-header{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-muted);margin-bottom:12px;font-family:'IBM Plex Mono',monospace;display:flex;gap:8px;align-items:center;}
  .scale-dot{width:8px;height:8px;border-radius:50%;}
  .scale-item{margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid var(--border);}
  .scale-item:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0;}
  .scale-item-title{font-size:13px;font-weight:600;margin-bottom:4px;}
  .scale-item-desc{font-size:12px;color:var(--text-muted);line-height:1.5;}

  /* â•â•â• INFRA â•â•â• */
  #panel-infra{overflow-x:auto;}
  .infra-canvas{min-width:860px;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:32px;}
  .infra-title{font-family:'IBM Plex Mono',monospace;font-size:11px;letter-spacing:0.15em;text-transform:uppercase;color:var(--text-muted);margin-bottom:28px;display:flex;align-items:center;gap:10px;}
  .infra-title::after{content:'';flex:1;height:1px;background:var(--border);}
  .cloud-zone{border:1px dashed;border-radius:12px;padding:20px;margin-bottom:16px;position:relative;}
  .cloud-zone.aws{border-color:rgba(245,158,11,0.35);background:rgba(245,158,11,0.025);}
  .cloud-zone.azure-ext{border-color:rgba(96,165,250,0.35);background:rgba(96,165,250,0.02);}
  .cloud-zone.saas-ext{border-color:rgba(124,58,237,0.35);background:rgba(124,58,237,0.02);}
  .cloud-zone.users-zone{border-color:rgba(0,196,255,0.25);background:rgba(0,196,255,0.015);}
  .zone-label{position:absolute;top:-11px;left:20px;font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:600;letter-spacing:0.15em;text-transform:uppercase;padding:0 8px;background:var(--surface);}
  .zone-label.aws{color:var(--accent4);}.zone-label.azure-ext{color:#60a5fa;}.zone-label.saas-ext{color:var(--accent2);}.zone-label.users-zone{color:var(--accent);}
  .infra-row{display:flex;gap:12px;align-items:stretch;flex-wrap:wrap;margin-bottom:12px;}
  .infra-row:last-child{margin-bottom:0;}
  .inode{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:11px 14px;flex:1;min-width:130px;transition:all 0.2s;}
  .inode:hover{border-color:var(--border-bright);transform:translateY(-2px);box-shadow:0 4px 20px rgba(0,0,0,0.3);}
  .inode-icon{font-size:17px;margin-bottom:5px;}
  .inode-name{font-size:12px;font-weight:600;color:var(--text);margin-bottom:2px;}
  .inode-detail{font-size:10px;color:var(--text-muted);line-height:1.4;}
  .inode-badge{display:inline-block;font-family:'IBM Plex Mono',monospace;font-size:9px;padding:1px 6px;border-radius:3px;margin-top:5px;}
  .inode-badge.managed{background:rgba(16,185,129,0.12);color:var(--accent3);border:1px solid rgba(16,185,129,0.3);}
  .inode-badge.ha{background:rgba(0,196,255,0.1);color:var(--accent);border:1px solid rgba(0,196,255,0.3);}
  .inode-badge.ext-badge{background:rgba(124,58,237,0.1);color:var(--accent2);border:1px solid rgba(124,58,237,0.3);}
  .infra-section-label{font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px;margin-top:4px;}
  .connector-row{display:flex;justify-content:center;align-items:center;padding:4px 0;gap:48px;}
  .connector{display:flex;flex-direction:column;align-items:center;gap:2px;font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--text-muted);}
  .connector-line{width:1px;height:26px;position:relative;}
  .connector-line::after{content:'â–¼';position:absolute;bottom:-7px;left:50%;transform:translateX(-50%);font-size:8px;}
  .connector-line.blue{background:linear-gradient(to bottom,rgba(0,196,255,0.5),transparent);}.connector-line.blue::after{color:var(--accent);}
  .connector-line.purple{background:linear-gradient(to bottom,rgba(124,58,237,0.5),transparent);}.connector-line.purple::after{color:var(--accent2);}
  .connector-line.green{background:linear-gradient(to bottom,rgba(16,185,129,0.5),transparent);}.connector-line.green::after{color:var(--accent3);}
  .connector-line.amber{background:linear-gradient(to bottom,rgba(245,158,11,0.5),transparent);}.connector-line.amber::after{color:var(--accent4);}
  .az-container{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;}
  .az-zone{border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:12px;background:rgba(255,255,255,0.012);}
  .az-label{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px;}
  .az-items{display:flex;flex-direction:column;gap:7px;}
  .az-item{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:7px 11px;font-size:11px;color:var(--text-dim);display:flex;align-items:center;gap:8px;}
  .az-item-icon{font-size:14px;}

  /* â•â•â• COST CALCULATOR â•â•â• */
  .cost-layout{display:grid;grid-template-columns:290px 1fr;gap:24px;align-items:start;}
  .cost-controls{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;position:sticky;top:20px;}
  .cost-controls-title{font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:0.15em;text-transform:uppercase;color:var(--accent);margin-bottom:20px;}
  .control-group{margin-bottom:16px;}
  .control-label{font-size:12px;font-weight:600;color:var(--text-dim);margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;}
  .control-value{font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--accent);background:rgba(0,196,255,0.08);border:1px solid rgba(0,196,255,0.2);border-radius:4px;padding:1px 7px;}
  input[type=range]{width:100%;-webkit-appearance:none;height:4px;border-radius:2px;background:var(--border);outline:none;margin-top:4px;}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 0 8px rgba(0,196,255,0.4);}
  .control-options{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;}
  .opt-btn{padding:4px 10px;border-radius:5px;font-size:11px;font-family:'IBM Plex Mono',monospace;border:1px solid var(--border);background:transparent;color:var(--text-muted);cursor:pointer;transition:all 0.15s;}
  .opt-btn:hover{border-color:var(--border-bright);color:var(--text);}
  .opt-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(0,196,255,0.08);}
  .cost-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;}
  .cost-stat{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px 18px;text-align:center;}
  .cost-stat-label{font-size:10px;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.08em;font-family:'IBM Plex Mono',monospace;}
  .cost-stat-value{font-size:26px;font-weight:700;color:var(--text);font-family:'IBM Plex Mono',monospace;}
  .cost-stat-sub{font-size:10px;color:var(--text-muted);margin-top:3px;}
  .cost-stat.highlight{border-color:var(--accent3);}.cost-stat.highlight .cost-stat-value{color:var(--accent3);}
  .cost-stat.warn{border-color:var(--accent4);}.cost-stat.warn .cost-stat-value{color:var(--accent4);}
  .cost-breakdown{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;}
  .breakdown-header{display:grid;grid-template-columns:1fr 90px 90px 100px 28px;gap:8px;padding:11px 18px;background:var(--surface2);border-bottom:1px solid var(--border);font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-muted);font-family:'IBM Plex Mono',monospace;}
  .breakdown-row{display:grid;grid-template-columns:1fr 90px 90px 100px 28px;gap:8px;padding:11px 18px;border-bottom:1px solid var(--border);align-items:center;transition:background 0.15s;}
  .breakdown-row:last-child{border-bottom:none;}
  .breakdown-row:hover{background:var(--surface2);}
  .br-service{display:flex;align-items:center;gap:9px;}
  .br-icon{font-size:16px;}.br-name{font-size:13px;font-weight:500;}.br-desc{font-size:10px;color:var(--text-muted);}
  .br-tier{font-size:11px;color:var(--text-muted);font-family:'IBM Plex Mono',monospace;}
  .br-launch{font-size:13px;font-weight:600;font-family:'IBM Plex Mono',monospace;}
  .br-scale{font-size:13px;font-weight:600;font-family:'IBM Plex Mono',monospace;color:var(--accent4);}
  .br-bar-inner{height:4px;border-radius:2px;background:var(--accent);transition:width 0.4s ease;}
  .cost-footer{display:grid;grid-template-columns:1fr 90px 90px 100px 28px;gap:8px;padding:13px 18px;background:var(--surface2);border-top:2px solid var(--border);font-weight:700;font-family:'IBM Plex Mono',monospace;}
  .cf-label{font-size:13px;color:var(--text);}
  .cf-launch{font-size:14px;color:var(--accent3);}
  .cf-scale{font-size:14px;color:var(--accent4);}
  .cost-notes{margin-top:18px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:18px;}
  .cost-notes-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-muted);margin-bottom:12px;font-family:'IBM Plex Mono',monospace;}
  .cost-note{display:flex;gap:10px;margin-bottom:8px;}
  .cost-note-dot{width:6px;height:6px;border-radius:50%;margin-top:6px;flex-shrink:0;}
  .cost-note-text{font-size:12px;color:var(--text-dim);line-height:1.5;}
  @media(max-width:900px){.cost-layout{grid-template-columns:1fr;}.cost-controls{position:static;}.tradeoff-grid{grid-template-columns:1fr;}.scale-grid{grid-template-columns:1fr;}.cost-summary{grid-template-columns:1fr;}.az-container{grid-template-columns:1fr;}.breakdown-header,.breakdown-row,.cost-footer{grid-template-columns:1fr 70px 70px 80px;}.breakdown-header>:last-child,.breakdown-row>:last-child,.cost-footer>:last-child{display:none;}}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="header-left">
      <h1>Architecture Design</h1>
      <h2>Reporting Hub <span>Replacement</span></h2>
      <p>Custom multi-tenant SaaS platform â€” full control over security, UI/UX, and embedded Power BI with RLS.</p>
    </div>
    <div class="header-meta">
      <div>Prepared for Sapiant</div>
      <div>Feb 2026</div>
      <div style="margin-top:8px;color:var(--accent);font-weight:600;">Click boxes for details â†’</div>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" onclick="showPanel('architecture',this)">Architecture</button>
    <button class="tab" onclick="showPanel('infra',this)">Infrastructure</button>
    <button class="tab" onclick="showPanel('cost',this)">Cost Calculator</button>
    <button class="tab" onclick="showPanel('rls',this)">Power BI RLS</button>
    <button class="tab" onclick="showPanel('tradeoffs',this)">Trade-offs</button>
    <button class="tab" onclick="showPanel('scalability',this)">Scalability</button>
    <button class="tab" onclick="showPanel('deno',this)">ğŸ¦• Deno Notes</button>
    <button class="tab" onclick="showPanel('tenancy',this)">ğŸ¢ Tenant Isolation</button>
    <button class="tab" onclick="showPanel('observability-tab',this)">ğŸ“¡ Observability</button>
    <button class="tab" onclick="showPanel('native-charts',this)">ğŸ“ˆ Native Charts</button>
    <button class="tab" onclick="showPanel('why-choices',this)">ğŸ§  Why These Choices</button>
  </div>

  <!-- â•â• ARCHITECTURE â•â• -->
  <div class="panel active" id="panel-architecture">
    <span class="hint">Click any component for details</span>
    <div class="arch-diagram">
      <div class="tier"><div class="tier-label client">Client Tier</div><div class="tier-row">
        <div class="box accent-blue" onclick="showDetail('nextjs')"><div class="box-icon">âš›ï¸</div><div class="box-title">Next.js Frontend</div><div class="box-sub">React 18 Â· App Router Â· SSR/SSG Â· TypeScript</div></div>
        <div class="box accent-blue" onclick="showDetail('pbi-embed')"><div class="box-icon">ğŸ“Š</div><div class="box-title">Power BI Embed SDK</div><div class="box-sub">powerbi-client-react Â· RLS via embed token</div></div>
        <div class="box accent-blue" onclick="showDetail('ui')"><div class="box-icon">ğŸ¨</div><div class="box-title">Design System</div><div class="box-sub">Tailwind CSS Â· shadcn/ui Â· Radix Â· Framer Motion</div></div>
      </div></div>
      <div class="flow-arrows"><div class="arrow-item"><div class="arrow-line"></div><span>HTTPS / REST</span></div><div class="arrow-item"><div class="arrow-line"></div><span>JWT tokens</span></div><div class="arrow-item"><div class="arrow-line"></div><span>WebSocket / SSE</span></div></div>
      <div class="tier"><div class="tier-label identity">Identity & Auth</div><div class="tier-row">
        <div class="box accent-purple" onclick="showDetail('auth0')"><div class="box-icon">ğŸ”</div><div class="box-title">Auth0 / Azure AD B2C</div><div class="box-sub">OIDC Â· OAuth 2.0 Â· MFA Â· SSO Â· Social login</div></div>
        <div class="box accent-purple" onclick="showDetail('rbac')"><div class="box-icon">ğŸ§©</div><div class="box-title">RBAC + Tenant Context</div><div class="box-sub">Roles Â· Permissions Â· Tenant isolation in JWT</div></div>
        <div class="box accent-purple" onclick="showDetail('session')"><div class="box-icon">ğŸªª</div><div class="box-title">Session Management</div><div class="box-sub">Refresh tokens Â· Short-lived JWTs Â· Secure cookies</div></div>
      </div></div>
      <div class="flow-arrows"><div class="arrow-item"><div class="arrow-line"></div><span>Authenticated requests</span></div></div>
      <div class="tier"><div class="tier-label gateway">API Gateway</div><div class="tier-row">
        <div class="box accent-amber" onclick="showDetail('gateway')"><div class="box-icon">ğŸš¦</div><div class="box-title">API Gateway / BFF</div><div class="box-sub">Rate limiting Â· Token validation Â· Request routing</div></div>
        <div class="box accent-amber" onclick="showDetail('middleware')"><div class="box-icon">ğŸ›¡ï¸</div><div class="box-title">Middleware Layer</div><div class="box-sub">Tenant resolution Â· Audit logging Â· CORS</div></div>
      </div></div>
      <div class="flow-arrows"><div class="arrow-item"><div class="arrow-line"></div><span>Internal service calls</span></div></div>
      <div class="tier"><div class="tier-label backend">Backend Services</div><div class="tier-row">
        <div class="box accent-green" onclick="showDetail('api')"><div class="box-icon">âš™ï¸</div><div class="box-title">Core API</div><div class="box-sub">Node.js Â· Fastify Â· REST Â· Business logic</div></div>
        <div class="box accent-green" onclick="showDetail('embed-service')"><div class="box-icon">ğŸ”‘</div><div class="box-title">Embed Token Service</div><div class="box-sub">Generates PBI embed tokens Â· Injects RLS identity</div></div>
        <div class="box accent-green" onclick="showDetail('tenant-service')"><div class="box-icon">ğŸ¢</div><div class="box-title">Tenant Service</div><div class="box-sub">Config Â· Feature flags Â· Nav menus Â· Branding</div></div>
        <div class="box accent-green" onclick="showDetail('ai-service')"><div class="box-icon">ğŸ¤–</div><div class="box-title">AI / Analytics Service</div><div class="box-sub">NL queries Â· Insights Â· OpenAI/Anthropic</div></div>
      </div></div>
      <div class="flow-arrows"><div class="arrow-item"><div class="arrow-line"></div><span>DB queries</span></div><div class="arrow-item"><div class="arrow-line"></div><span>PBI REST API</span></div><div class="arrow-item"><div class="arrow-line"></div><span>Cache reads</span></div></div>
      <div class="tier"><div class="tier-label data">Data & Storage</div><div class="tier-row">
        <div class="box accent-pink" onclick="showDetail('postgres')"><div class="box-icon">ğŸ˜</div><div class="box-title">PostgreSQL</div><div class="box-sub">Tenants Â· Users Â· Roles Â· Config Â· Audit logs</div></div>
        <div class="box accent-pink" onclick="showDetail('redis')"><div class="box-icon">âš¡</div><div class="box-title">Redis</div><div class="box-sub">Embed token cache Â· Sessions Â· Rate limits</div></div>
        <div class="box accent-pink" onclick="showDetail('blob')"><div class="box-icon">ğŸ—„ï¸</div><div class="box-title">Blob Storage</div><div class="box-sub">Logos Â· Exports Â· Report assets Â· S3</div></div>
        <div class="box accent-pink" onclick="showDetail('observability')"><div class="box-icon">ğŸ“¡</div><div class="box-title">Observability</div><div class="box-sub">DataDog / OpenTelemetry Â· Logs Â· Traces</div></div>
      </div></div>
      <div class="flow-arrows"><div class="arrow-item"><div class="arrow-line"></div><span>Embed token (with RLS claims)</span></div></div>
      <div class="tier"><div class="tier-label powerbi">Power BI Service (Microsoft)</div><div class="tier-row">
        <div class="box accent-blue" onclick="showDetail('pbi-service')"><div class="box-icon">ğŸ“ˆ</div><div class="box-title">Power BI Embedded</div><div class="box-sub">A-SKU capacity Â· Reports Â· RLS enforcement</div></div>
        <div class="box accent-blue" onclick="showDetail('pbi-api')"><div class="box-icon">ğŸ”Œ</div><div class="box-title">Power BI REST API</div><div class="box-sub">Token generation Â· Dataset refresh</div></div>
        <div class="box accent-blue" onclick="showDetail('pbi-rls')"><div class="box-icon">ğŸ›¡ï¸</div><div class="box-title">Row-Level Security</div><div class="box-sub">RLS roles Â· DAX filters Â· Username claims</div></div>
      </div></div>
    </div>
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:var(--accent)"></div>Client / PBI</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--accent2)"></div>Identity</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--accent4)"></div>Gateway</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--accent3)"></div>Backend</div>
      <div class="legend-item"><div class="legend-dot" style="background:#f472b6"></div>Data</div>
    </div>
  </div>

  <!-- â•â• INFRASTRUCTURE â•â• -->
  <div class="panel" id="panel-infra">
    <p style="color:var(--text-dim);font-size:14px;margin-bottom:20px;line-height:1.6;">How the logical architecture maps to real AWS cloud resources, with Power BI hosted on Azure and Auth0 as an external SaaS. Designed for high availability with multi-AZ deployments on all stateful components.</p>
    <div class="infra-canvas">
      <div class="infra-title">Infrastructure Diagram â€” AWS ap-southeast-2 + External Services</div>
      <div class="cloud-zone users-zone">
        <div class="zone-label users-zone">Users & Clients</div>
        <div class="infra-row">
          <div class="inode"><div class="inode-icon">ğŸ‘¤</div><div class="inode-name">Internal Users</div><div class="inode-detail">Sapiant staff Â· Admin console Â· Full feature set</div></div>
          <div class="inode"><div class="inode-icon">ğŸ¢</div><div class="inode-name">External Customers</div><div class="inode-detail">Tenant users Â· Data scoped by RLS</div></div>
          <div class="inode"><div class="inode-icon">ğŸŒ</div><div class="inode-name">Browser / Mobile</div><div class="inode-detail">HTTPS only Â· No installed client required</div></div>
        </div>
      </div>
      <div class="connector-row">
        <div class="connector"><div class="connector-line blue"></div><span>HTTPS / TLS 1.3</span></div>
        <div class="connector"><div class="connector-line blue"></div><span>CloudFront Edge</span></div>
      </div>
      <div class="cloud-zone aws">
        <div class="zone-label aws">â˜ AWS â€” ap-southeast-2 (Sydney)</div>
        <div class="infra-section-label">Edge & Security</div>
        <div class="infra-row" style="margin-bottom:18px;">
          <div class="inode"><div class="inode-icon">ğŸŒ</div><div class="inode-name">CloudFront CDN</div><div class="inode-detail">Global PoPs Â· Static assets Â· Cache headers Â· HTTPS enforcement</div><div><span class="inode-badge managed">Managed</span></div></div>
          <div class="inode"><div class="inode-icon">ğŸ›¡ï¸</div><div class="inode-name">AWS WAF</div><div class="inode-detail">Rate limiting Â· IP blocking Â· OWASP Top 10 rules Â· Bot protection</div><div><span class="inode-badge managed">Managed</span></div></div>
          <div class="inode"><div class="inode-icon">âš–ï¸</div><div class="inode-name">Application Load Balancer</div><div class="inode-detail">Multi-AZ Â· SSL termination Â· Health checks Â· Path-based routing</div><div><span class="inode-badge ha">Multi-AZ</span></div></div>
          <div class="inode"><div class="inode-icon">ğŸŒ</div><div class="inode-name">Route 53</div><div class="inode-detail">DNS routing Â· Health-check failover Â· Per-tenant subdomains (*.app.com)</div><div><span class="inode-badge managed">Managed</span></div></div>
        </div>
        <div class="infra-section-label">Compute â€” ECS Fargate (Multi-AZ, Auto-Scaling)</div>
        <div class="az-container" style="margin-bottom:18px;">
          <div class="az-zone">
            <div class="az-label">Availability Zone A</div>
            <div class="az-items">
              <div class="az-item"><div class="az-item-icon">ğŸ³</div><div><div style="font-size:11px;font-weight:600;color:var(--text)">Next.js App (2â€“10 tasks)</div><div style="font-size:10px;color:var(--text-muted)">0.5 vCPU / 1 GB Â· SSR + API routes Â· Node.js 20</div></div></div>
              <div class="az-item"><div class="az-item-icon">ğŸ¦•</div><div><div style="font-size:11px;font-weight:600;color:var(--text)">Core API Service (2â€“8 tasks)</div><div style="font-size:10px;color:var(--text-muted)">0.5 vCPU / 1 GB Â· Fastify REST API Â· Deno 2</div></div></div>
              <div class="az-item"><div class="az-item-icon">ğŸ¦•</div><div><div style="font-size:11px;font-weight:600;color:var(--text)">Embed Token Service (2â€“4 tasks)</div><div style="font-size:10px;color:var(--text-muted)">0.25 vCPU / 512 MB Â· PBI token gen Â· Deno 2</div></div></div>
            </div>
          </div>
          <div class="az-zone">
            <div class="az-label">Availability Zone B</div>
            <div class="az-items">
              <div class="az-item"><div class="az-item-icon">ğŸ³</div><div><div style="font-size:11px;font-weight:600;color:var(--text)">Next.js App (mirror)</div><div style="font-size:10px;color:var(--text-muted)">Auto-scaled replica of AZ-A</div></div></div>
              <div class="az-item"><div class="az-item-icon">ğŸ¦•</div><div><div style="font-size:11px;font-weight:600;color:var(--text)">Core API Service (mirror)</div><div style="font-size:10px;color:var(--text-muted)">Auto-scaled replica of AZ-A</div></div></div>
              <div class="az-item"><div class="az-item-icon">ğŸ¦•</div><div><div style="font-size:11px;font-weight:600;color:var(--text)">Embed Token Service (mirror)</div><div style="font-size:10px;color:var(--text-muted)">Auto-scaled replica of AZ-A</div></div></div>
            </div>
          </div>
        </div>
        <div class="infra-section-label">Data Layer</div>
        <div class="infra-row" style="margin-bottom:18px;">
          <div class="inode"><div class="inode-icon">ğŸ˜</div><div class="inode-name">RDS PostgreSQL</div><div class="inode-detail">db.t4g.medium Â· Multi-AZ standby Â· Read replica Â· Auto-backups 7d</div><div><span class="inode-badge ha">Multi-AZ</span></div></div>
          <div class="inode"><div class="inode-icon">âš¡</div><div class="inode-name">ElastiCache Redis</div><div class="inode-detail">cache.t4g.micro Â· Cluster mode Â· 2 replicas Â· Embed token + session cache</div><div><span class="inode-badge ha">Clustered</span></div></div>
          <div class="inode"><div class="inode-icon">ğŸ—„ï¸</div><div class="inode-name">S3 Buckets</div><div class="inode-detail">Tenant assets Â· Report exports Â· Versioning Â· SSE-S3 encryption</div><div><span class="inode-badge managed">Managed</span></div></div>
          <div class="inode"><div class="inode-icon">ğŸ”’</div><div class="inode-name">Secrets Manager</div><div class="inode-detail">DB creds Â· PBI service principal Â· API keys Â· Auto-rotation enabled</div><div><span class="inode-badge managed">Managed</span></div></div>
        </div>
        <div class="infra-section-label">CI/CD & Observability</div>
        <div class="infra-row">
          <div class="inode"><div class="inode-icon">ğŸ“¦</div><div class="inode-name">ECR (Container Registry)</div><div class="inode-detail">Docker images Â· Vulnerability scanning Â· Immutable tags</div><div><span class="inode-badge managed">Managed</span></div></div>
          <div class="inode"><div class="inode-icon">ğŸš€</div><div class="inode-name">CodePipeline + CodeBuild</div><div class="inode-detail">CI/CD pipeline Â· Blue-green ECS deploys Â· Automated rollback</div><div><span class="inode-badge managed">Managed</span></div></div>
          <div class="inode"><div class="inode-icon">ğŸ“¡</div><div class="inode-name">CloudWatch</div><div class="inode-detail">Container insights Â· Log groups Â· Custom metrics Â· Alarms â†’ SNS</div><div><span class="inode-badge managed">Managed</span></div></div>
        </div>
      </div>
      <div class="connector-row">
        <div class="connector"><div class="connector-line purple"></div><span>OIDC login flow</span></div>
        <div class="connector"><div class="connector-line blue"></div><span>PBI REST API (HTTPS)</span></div>
        <div class="connector"><div class="connector-line green"></div><span>Email / AI APIs</span></div>
      </div>
      <div class="cloud-zone saas-ext">
        <div class="zone-label saas-ext">External SaaS / Managed Services</div>
        <div class="infra-row">
          <div class="inode"><div class="inode-icon">ğŸ”</div><div class="inode-name">Auth0</div><div class="inode-detail">Identity provider Â· MFA Â· SSO Â· Enterprise IdP connectors Â· JWT issuer</div><div><span class="inode-badge ext-badge">SaaS</span></div></div>
          <div class="inode"><div class="inode-icon">ğŸ“§</div><div class="inode-name">SES / SendGrid</div><div class="inode-detail">Transactional email Â· User invites Â· Notifications Â· Report delivery</div><div><span class="inode-badge ext-badge">SaaS</span></div></div>
          <div class="inode"><div class="inode-icon">ğŸ¤–</div><div class="inode-name">OpenAI / Anthropic</div><div class="inode-detail">AI features Â· NL-to-query Â· Report summaries Â· Insights (optional)</div><div><span class="inode-badge ext-badge">SaaS</span></div></div>
        </div>
      </div>
      <div class="connector-row">
        <div class="connector"><div class="connector-line blue"></div><span>Embed token â†’ browser</span></div>
        <div class="connector"><div class="connector-line amber"></div><span>Azure AD service principal</span></div>
      </div>
      <div class="cloud-zone azure-ext">
        <div class="zone-label azure-ext">â˜ Microsoft Azure â€” Power BI Service</div>
        <div class="infra-row">
          <div class="inode"><div class="inode-icon">ğŸ“Š</div><div class="inode-name">Power BI Embedded (A1 SKU)</div><div class="inode-detail">~$735/mo Â· Reserved capacity Â· ~300 concurrent renders Â· Autoscale to A2/A3</div><div><span class="inode-badge ext-badge">Azure</span></div></div>
          <div class="inode"><div class="inode-icon">ğŸ“</div><div class="inode-name">Power BI Workspaces</div><div class="inode-detail">One workspace per tenant (recommended) Â· Reports Â· Datasets Â· RLS configured</div><div><span class="inode-badge ext-badge">Azure</span></div></div>
          <div class="inode"><div class="inode-icon">ğŸ”‘</div><div class="inode-name">Azure AD App Registration</div><div class="inode-detail">Service principal Â· Used by Embed Token Service only Â· Credentials in Secrets Manager</div><div><span class="inode-badge ext-badge">Azure AD</span></div></div>
        </div>
      </div>
      <div style="margin-top:24px;padding-top:20px;border-top:1px solid var(--border);">
        <div style="font-size:10px;font-family:'IBM Plex Mono',monospace;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:10px;">Key Request Paths</div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div style="display:flex;align-items:center;gap:10px;font-size:12px;color:var(--text-dim)"><div style="width:28px;height:2px;background:var(--accent);border-radius:1px;flex-shrink:0;"></div>Page load: User â†’ CloudFront â†’ WAF â†’ ALB â†’ ECS Next.js (SSR) â†’ RDS (tenant config)</div>
          <div style="display:flex;align-items:center;gap:10px;font-size:12px;color:var(--text-dim)"><div style="width:28px;height:2px;background:var(--accent2);border-radius:1px;flex-shrink:0;"></div>Login: Browser â†’ Auth0 (OIDC) â†’ JWT in httpOnly cookie â†’ all subsequent API calls</div>
          <div style="display:flex;align-items:center;gap:10px;font-size:12px;color:var(--text-dim)"><div style="width:28px;height:2px;background:var(--accent3);border-radius:1px;flex-shrink:0;"></div>Report load: Browser â†’ Embed Svc (Deno) â†’ Redis (cache hit?) â†’ PBI REST API â†’ embed token â†’ browser â†’ Power BI renders</div>
          <div style="display:flex;align-items:center;gap:10px;font-size:12px;color:var(--text-dim)"><div style="width:28px;height:2px;background:var(--accent4);border-radius:1px;flex-shrink:0;"></div>Secrets: ECS tasks pull from Secrets Manager at startup â€” never baked into images or env vars</div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â• COST CALCULATOR â•â• -->
  <div class="panel" id="panel-cost">
    <div style="background:rgba(0,196,255,0.06);border:1px solid rgba(0,196,255,0.2);border-radius:10px;padding:14px 18px;margin-bottom:24px;display:flex;align-items:center;gap:12px;">
      <div style="font-size:20px;">ğŸ“‹</div>
      <div>
        <div style="font-size:12px;font-weight:600;color:var(--accent);margin-bottom:3px;">Based on your inputs</div>
        <div style="font-size:13px;color:var(--text-dim);">10â€“50 tenants at launch â†’ 50â€“200 at 12mo &nbsp;Â·&nbsp; 500â€“2,000 peak concurrent users &nbsp;Â·&nbsp; AWS or Azure hosting. Sliders pre-loaded to mid-range of your estimates.</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:24px;padding:16px 20px;background:var(--surface);border:1px solid var(--border);border-radius:10px;">
      <div style="font-size:12px;font-weight:600;color:var(--text-dim);white-space:nowrap;">â˜ Cloud Provider:</div>
      <div class="control-options">
        <button class="opt-btn active" id="opt-cloud-aws" onclick="setCloud('aws')">AWS (ap-southeast-2)</button>
        <button class="opt-btn" id="opt-cloud-azure" onclick="setCloud('azure')">Azure (australiaeast)</button>
      </div>
      <div id="cloud-note" style="font-size:11px;color:var(--text-muted);margin-left:8px;"></div>
      <div style="margin-left:auto;">
        <button class="opt-btn" id="btn-compare" onclick="toggleCompare()" style="border-color:var(--accent3);color:var(--accent3);">â‡„ Compare Both</button>
      </div>
    </div>
    <div id="compare-panel" style="display:none;margin-bottom:24px;">
      <div style="font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.15em;margin-bottom:14px;">AWS vs Azure â€” Cost Comparison (based on current slider values)</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div style="background:var(--surface);border:1px solid rgba(245,158,11,0.3);border-radius:10px;overflow:hidden;">
          <div style="background:rgba(245,158,11,0.08);padding:12px 16px;border-bottom:1px solid rgba(245,158,11,0.2);font-size:12px;font-weight:600;color:var(--accent4);">â˜ AWS ap-southeast-2</div>
          <div id="compare-aws" style="padding:14px 16px;"></div>
        </div>
        <div style="background:var(--surface);border:1px solid rgba(96,165,250,0.3);border-radius:10px;overflow:hidden;">
          <div style="background:rgba(96,165,250,0.08);padding:12px 16px;border-bottom:1px solid rgba(96,165,250,0.2);font-size:12px;font-weight:600;color:#60a5fa;">â˜ Azure australiaeast</div>
          <div id="compare-azure" style="padding:14px 16px;"></div>
        </div>
      </div>
      <div style="margin-top:12px;padding:12px 16px;background:var(--surface);border:1px solid var(--border);border-radius:8px;font-size:12px;color:var(--text-dim);line-height:1.6;" id="compare-verdict"></div>
    </div>
    <div class="cost-layout">
      <div class="cost-controls">
        <div class="cost-controls-title">âš™ Parameters</div>
        <div class="control-group">
          <div class="control-label">Tenants (launch â†’ 12mo)</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px;">
            <div>
              <div style="font-size:10px;color:var(--text-muted);margin-bottom:4px;">Launch <span class="control-value" id="lbl-tenants-launch">25</span></div>
              <input type="range" min="1" max="200" value="25" id="sl-tenants-launch" oninput="recalc()">
            </div>
            <div>
              <div style="font-size:10px;color:var(--text-muted);margin-bottom:4px;">12 months <span class="control-value" id="lbl-tenants-scale">100</span></div>
              <input type="range" min="1" max="500" value="100" id="sl-tenants-scale" oninput="recalc()">
            </div>
          </div>
        </div>
        <div class="control-group">
          <div class="control-label">Monthly Active Users <span class="control-value" id="lbl-mau">2000</span></div>
          <input type="range" min="50" max="20000" value="2000" step="100" id="sl-mau" oninput="recalc()">
        </div>
        <div class="control-group">
          <div class="control-label">Peak Concurrent Users <span class="control-value" id="lbl-concurrent">1000</span></div>
          <input type="range" min="10" max="3000" value="1000" step="50" id="sl-concurrent" oninput="recalc()">
          <div id="pbi-sku-hint" style="font-size:10px;color:var(--accent4);margin-top:5px;"></div>
        </div>
        <div class="control-group">
          <div class="control-label">Power BI SKU</div>
          <div class="control-options">
            <button class="opt-btn" id="opt-a1" onclick="setPBI('A1')">A1 Â· $735</button>
            <button class="opt-btn active" id="opt-a2" onclick="setPBI('A2')">A2 Â· $1,470</button>
            <button class="opt-btn" id="opt-a3" onclick="setPBI('A3')">A3 Â· $2,941</button>
          </div>
          <div style="font-size:10px;color:var(--text-muted);margin-top:5px;">A1 â‰ˆ 300 concurrent Â· A2 â‰ˆ 600 Â· A3 â‰ˆ 1,200</div>
        </div>
        <div class="control-group">
          <div class="control-label">Auth Provider</div>
          <div class="control-options">
            <button class="opt-btn active" id="opt-auth0" onclick="setAuth('auth0')">Auth0</button>
            <button class="opt-btn" id="opt-azuread" onclick="setAuth('azuread')">Azure AD B2C</button>
          </div>
          <div id="auth-note" style="font-size:10px;color:var(--text-muted);margin-top:5px;"></div>
        </div>
        <div class="control-group">
          <div class="control-label">AI Features</div>
          <div class="control-options">
            <button class="opt-btn active" id="opt-ai-off" onclick="setAI(false)">Off</button>
            <button class="opt-btn" id="opt-ai-on" onclick="setAI(true)">On</button>
          </div>
        </div>
        <div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border);">
          <div style="font-size:11px;color:var(--text-muted);line-height:1.5;margin-bottom:8px;">Compute pricing:</div>
          <div class="control-options">
            <button class="opt-btn active" id="opt-od" onclick="setRI(false)">On-demand</button>
            <button class="opt-btn" id="opt-ri" onclick="setRI(true)">Reserved (1yr ~35% off)</button>
          </div>
        </div>
        <div id="insight-box" style="margin-top:20px;padding:14px;background:var(--surface2);border-radius:8px;border-left:3px solid var(--accent4);"></div>
      </div>
      <div>
        <div class="cost-summary">
          <div class="cost-stat">
            <div class="cost-stat-label">Launch /mo</div>
            <div class="cost-stat-value" id="stat-launch">$0</div>
            <div class="cost-stat-sub" id="stat-launch-sub">~25 tenants</div>
          </div>
          <div class="cost-stat warn">
            <div class="cost-stat-label">12 Months /mo</div>
            <div class="cost-stat-value" id="stat-scale">$0</div>
            <div class="cost-stat-sub" id="stat-scale-sub">~100 tenants</div>
          </div>
          <div class="cost-stat highlight">
            <div class="cost-stat-label">Year 1 Total</div>
            <div class="cost-stat-value" id="stat-annual">$0</div>
            <div class="cost-stat-sub">6mo launch + 6mo scale</div>
          </div>
        </div>
        <div id="pbi-warning" style="margin-bottom:16px;padding:12px 16px;background:var(--surface);border:1px solid var(--border);border-radius:8px;display:none;">
          <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:0.08em;">Cost Breakdown by Category</div>
          <div id="cost-bar-chart"></div>
        </div>
        <div class="cost-breakdown">
          <div class="breakdown-header">
            <div>Service</div><div>Tier</div><div>Launch /mo</div><div>Scale /mo</div><div></div>
          </div>
          <div id="breakdown-rows"></div>
          <div class="cost-footer">
            <div class="cf-label">Total</div><div></div>
            <div class="cf-launch" id="footer-launch">$0</div>
            <div class="cf-scale" id="footer-scale">$0</div>
            <div></div>
          </div>
        </div>
        <div class="cost-notes">
          <div class="cost-notes-title">ğŸ“Œ Notes for your scale (500â€“2,000 concurrent users)</div>
          <div class="cost-note"><div class="cost-note-dot" style="background:var(--accent4)"></div><div class="cost-note-text"><strong style="color:var(--text)">Power BI A2 SKU is strongly recommended at your scale.</strong> 500â€“2,000 concurrent users means A1 (300 max) will be insufficient at peak. A2 at $1,470/mo handles up to ~600 concurrent renders. At 2,000 concurrent you'd need A3 ($2,941/mo). This is your biggest cost lever â€” plan for A2 at minimum.</div></div>
          <div class="cost-note"><div class="cost-note-dot" style="background:var(--accent3)"></div><div class="cost-note-text"><strong style="color:var(--text)">AWS vs Azure:</strong> For your scale, AWS is slightly cheaper on compute and has better Fargate tooling. Azure wins if your team already uses Azure DevOps or if keeping everything in one Microsoft ecosystem (Power BI + Azure AD B2C + App Service) simplifies your ops model. Both are within ~10% of each other in total cost.</div></div>
          <div class="cost-note"><div class="cost-note-dot" style="background:var(--accent2)"></div><div class="cost-note-text"><strong style="color:var(--text)">Auth0 vs Azure AD B2C at 2,000 MAU:</strong> Auth0 costs ~$0 (under 7,500 MAU free tier). At 50+ tenants with enterprise SSO connections, it becomes significant. Azure AD B2C has 50,000 MAU free â€” meaningful at your scale.</div></div>
          <div class="cost-note"><div class="cost-note-dot" style="background:var(--accent)"></div><div class="cost-note-text"><strong style="color:var(--text)">50â€“200 tenants means tenant config caching is critical.</strong> Every tenant has a navigation tree, branding, and report mappings. At 200 tenants, Redis caching of this config saves ~200 DB round-trips per minute at peak. Budget for a slightly larger Redis cluster than the minimum.</div></div>
          <div class="cost-note"><div class="cost-note-dot" style="background:var(--accent5)"></div><div class="cost-note-text"><strong style="color:var(--text)">Reserved Instances save ~$400â€“600/mo</strong> at this scale on AWS. Commit after 3 months when traffic patterns are clear â€” at 1-year no-upfront it's a near-zero risk commitment.</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â• RLS â•â• -->
  <div class="panel" id="panel-rls">
    <p style="color:var(--text-dim);font-size:14px;margin-bottom:24px;line-height:1.6;">This is the most critical security flow. Power BI enforces row-level security based on identity claims we inject into the embed token. Here's the step-by-step flow every time a user loads a report:</p>

    <div style="background:rgba(0,196,255,0.06);border:1px solid rgba(0,196,255,0.25);border-radius:10px;padding:16px 18px;margin-bottom:24px;display:grid;grid-template-columns:1fr 1fr;gap:20px;">
      <div>
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent);margin-bottom:8px;">Embedding Model: App Owns Data</div>
        <div style="font-size:12px;color:var(--text-dim);line-height:1.6;">We use the <strong style="color:var(--text)">"App Owns Data"</strong> embedding model â€” not "User Owns Data." This is the correct choice for a multi-tenant SaaS: our application (via a service principal) owns the Power BI workspace and generates embed tokens on behalf of users. End users do NOT need Power BI licences. The service principal authenticates to Azure AD using client credentials (client ID + secret or certificate), gets an access token, then calls the Power BI REST API to generate a short-lived embed token with RLS identity injected.</div>
      </div>
      <div>
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent);margin-bottom:8px;">Why NOT User Owns Data</div>
        <div style="font-size:12px;color:var(--text-dim);line-height:1.6;">"User Owns Data" requires every user to have a Power BI Pro or Premium Per User licence (~$10â€“20/user/month) and sign in directly to Microsoft. For a white-label SaaS with external customers who shouldn't know or care about Power BI's existence, this is completely wrong. "App Owns Data" is the right model: our service principal is the only entity that needs Power BI permissions. Users just get a short-lived embed token that works anonymously from Power BI's perspective.</div>
      </div>
    </div>
    <div class="rls-flow">
      <div class="rls-step"><div class="rls-num" style="background:rgba(0,196,255,0.1);border:1px solid var(--accent);color:var(--accent)">1</div><div class="rls-step-content"><h4>User authenticates</h4><p>User logs in via Auth0/Azure AD B2C. A JWT is issued containing user ID, email, tenant ID, and roles. Stored in a secure httpOnly cookie.</p><code>{ sub, email, tenantId, roles[], orgId }</code></div></div>
      <div class="rls-step"><div class="rls-num" style="background:rgba(124,58,237,0.1);border:1px solid var(--accent2);color:var(--accent2)">2</div><div class="rls-step-content"><h4>Frontend requests embed token</h4><p>When a report page loads, the frontend calls our backend â€” passing the user's JWT in the cookie automatically.</p><code>POST /api/reports/:reportId/embed-token</code></div></div>
      <div class="rls-step"><div class="rls-num" style="background:rgba(245,158,11,0.1);border:1px solid var(--accent4);color:var(--accent4)">3</div><div class="rls-step-content"><h4>Backend validates + resolves context</h4><p>Embed Token Service (Deno) verifies the JWT, resolves tenant config, and determines which Power BI workspace and report this user can access.</p><code>tenantId â†’ workspaceId + reportId + RLS role</code></div></div>
      <div class="rls-step"><div class="rls-num" style="background:rgba(16,185,129,0.1);border:1px solid var(--accent3);color:var(--accent3)">4</div><div class="rls-step-content"><h4>Embed token generated with RLS claims</h4><p>We call the Power BI REST API using a service principal (App Owns Data model). We pass the user's identity and the RLS role. Power BI returns a short-lived embed token (1 hour).</p><code>GenerateTokenInGroup({ identities: [{ username, roles, datasets }] })</code></div></div>
      <div class="rls-step"><div class="rls-num" style="background:rgba(0,196,255,0.1);border:1px solid var(--accent);color:var(--accent)">5</div><div class="rls-step-content"><h4>Token cached in Redis</h4><p>The embed token is cached in Redis keyed by user + report + tenant for ~45 minutes to avoid hammering the Power BI API on every page load.</p><code>pbi:embed:{tenantId}:{userId}:{reportId} (TTL 45m)</code></div></div>
      <div class="rls-step"><div class="rls-num" style="background:rgba(244,114,182,0.1);border:1px solid #f472b6;color:#f472b6">6</div><div class="rls-step-content"><h4>Frontend embeds the report</h4><p>The embed token is returned to the frontend. The Power BI SDK renders the report. Power BI enforces RLS server-side â€” the user can only see rows matching their identity.</p><code>powerbi.embed(element, { type: 'report', accessToken })</code></div></div>
      <div class="rls-step"><div class="rls-num" style="background:rgba(245,158,11,0.1);border:1px solid var(--accent4);color:var(--accent4)">7</div><div class="rls-step-content"><h4>Silent token refresh</h4><p>The frontend tracks token expiry. Before it expires, it silently requests a new embed token. No page reload â€” the SDK supports hot token swap.</p></div></div>
    </div>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:18px;margin-bottom:16px;">
      <div style="font-size:11px;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:0.12em;color:var(--accent3);margin-bottom:14px;">Actual API Call â€” GenerateTokenInGroup</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div>
          <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;font-family:'IBM Plex Mono',monospace;">Request body sent to Power BI REST API</div>
          <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;background:var(--bg);border:1px solid var(--border);padding:12px 14px;border-radius:6px;color:var(--accent3);line-height:1.8;">POST /v1.0/myorg/groups/{workspaceId}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/reports/{reportId}/GenerateToken<br><br>{<br>&nbsp;&nbsp;<span style="color:var(--text-dim)">"accessLevel"</span>: <span style="color:var(--accent4)">"view"</span>,<br>&nbsp;&nbsp;<span style="color:var(--text-dim)">"identities"</span>: [<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:var(--text-dim)">"username"</span>: <span style="color:var(--accent4)">"tenant-acme-corp"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:var(--text-dim)">"roles"</span>: [<span style="color:var(--accent4)">"TenantViewer"</span>],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:var(--text-dim)">"datasets"</span>: [<span style="color:var(--accent4)">"dataset-guid-here"</span>]<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;]<br>}</div>
        </div>
        <div>
          <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;font-family:'IBM Plex Mono',monospace;">Corresponding DAX filter in Power BI dataset</div>
          <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;background:var(--bg);border:1px solid var(--border);padding:12px 14px;border-radius:6px;color:var(--accent3);line-height:1.8;"><span style="color:var(--text-muted)">-- RLS role: TenantViewer</span><br><span style="color:var(--text-muted)">-- DAX filter expression:</span><br>[TenantSlug] = USERPRINCIPALNAME()<br><br><span style="color:var(--text-muted)">-- username in embed token maps to</span><br><span style="color:var(--text-muted)">-- USERPRINCIPALNAME() in DAX.</span><br><span style="color:var(--text-muted)">-- We pass tenantId as the username.</span><br><span style="color:var(--text-muted)">-- Power BI filters rows accordingly.</span><br><br><span style="color:var(--text-dim)">-- For row-level user scoping:</span><br>[UserId] = <span style="color:var(--accent4)">"user-id-via-customData"</span></div>
          <div style="margin-top:8px;padding:8px 10px;background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.2);border-radius:5px;font-size:11px;color:var(--text-dim);line-height:1.5;"><strong style="color:var(--accent4)">customData</strong> claim: for more complex RLS (e.g. restricting by both tenant AND specific user rows), pass additional context via the <code style="font-family:'IBM Plex Mono',monospace;font-size:10px;">customData</code> field in the identity object. Available as <code style="font-family:'IBM Plex Mono',monospace;font-size:10px;">CUSTOMDATA()</code> in DAX filters.</div>
        </div>
      </div>
    </div>
    <div style="background:var(--surface);border:1px solid var(--accent4);border-radius:10px;padding:18px;">
      <div style="font-size:12px;font-weight:600;color:var(--accent4);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px;">âš ï¸ Key Security Principle</div>
      <p style="font-size:13px;color:var(--text-dim);line-height:1.6;">Power BI service principal credentials and workspace IDs <strong style="color:var(--text)">never reach the browser</strong>. All Power BI REST API calls happen server-side in the Deno Embed Token Service. The frontend only receives short-lived embed tokens. Tenants are isolated at both the application layer (our DB) and the Power BI layer (RLS roles).</p>
    </div>
  </div>

  <!-- â•â• TRADEOFFS â•â• -->
  <div class="panel" id="panel-tradeoffs">
    <p style="color:var(--text-dim);font-size:14px;margin-bottom:24px;line-height:1.6;">Every architecture decision involves trade-offs. Here are the meaningful ones:</p>
    <div class="tradeoff-grid">
      <div class="tradeoff-card"><div class="tradeoff-header"><div class="tradeoff-icon" style="background:rgba(0,196,255,0.1)">âš›ï¸</div><div><div class="tradeoff-title">Next.js full-stack vs separate Frontend + API</div><div class="tradeoff-subtitle">Co-location vs independent scaling</div></div></div><div class="tradeoff-body">Next.js lets us co-locate frontend and BFF logic, use Server Actions for secure operations, and deploy as a single unit.</div><div class="pro-con"><div class="pro"><div class="pro-title">Pros</div><ul><li>Simpler deployment</li><li>SSR for fast first load</li><li>One CI/CD pipeline</li></ul></div><div class="con"><div class="con-title">Cons</div><ul><li>Harder to scale independently</li><li>Larger deploy surface</li><li>Vercel lock-in risk</li></ul></div></div></div>
      <div class="tradeoff-card"><div class="tradeoff-header"><div class="tradeoff-icon" style="background:rgba(124,58,237,0.1)">ğŸ”</div><div><div class="tradeoff-title">Auth0 vs Roll-Your-Own Auth</div><div class="tradeoff-subtitle">Cost vs control</div></div></div><div class="tradeoff-body">Auth0 gives us battle-tested MFA, SSO, and enterprise identity connectors without building from scratch.</div><div class="pro-con"><div class="pro"><div class="pro-title">Auth0 Pros</div><ul><li>MFA/SSO out of box</li><li>Enterprise connectors</li><li>Faster to market</li></ul></div><div class="con"><div class="con-title">Cons</div><ul><li>Monthly cost at scale</li><li>External dependency</li><li>Less flow flexibility</li></ul></div></div></div>
      <div class="tradeoff-card"><div class="tradeoff-header"><div class="tradeoff-icon" style="background:rgba(16,185,129,0.1)">ğŸ“Š</div><div><div class="tradeoff-title">Keep Power BI vs Native Charts</div><div class="tradeoff-subtitle">Speed to market vs long-term cost</div></div></div><div class="tradeoff-body">Power BI is powerful and familiar but adds A-SKU cost and creates Microsoft dependency. Native charts give full control.</div><div class="pro-con"><div class="pro"><div class="pro-title">Keep PBI</div><ul><li>No rebuild effort</li><li>Rich built-in features</li><li>Stakeholders know it</li></ul></div><div class="con"><div class="con-title">Go Native</div><ul><li>Eliminate A-SKU cost</li><li>Full design control</li><li>Significant dev effort</li></ul></div></div></div>
      <div class="tradeoff-card"><div class="tradeoff-header"><div class="tradeoff-icon" style="background:rgba(245,158,11,0.1)">ğŸ—„ï¸</div><div><div class="tradeoff-title">Shared DB vs Isolated schemas</div><div class="tradeoff-subtitle">Cost vs isolation strength</div></div></div><div class="tradeoff-body">Shared database with tenantId column + Postgres RLS is simpler and cheaper. Schema-per-tenant offers stronger isolation but painful migrations.</div><div class="pro-con"><div class="pro"><div class="pro-title">Shared DB</div><ul><li>Lower cost</li><li>Simple migrations</li><li>Easier to operate</li></ul></div><div class="con"><div class="con-title">Isolated schemas</div><ul><li>Stronger isolation</li><li>Better compliance story</li><li>Complex migrations</li></ul></div></div></div>
      <div class="tradeoff-card"><div class="tradeoff-header"><div class="tradeoff-icon" style="background:rgba(16,185,129,0.1)">ğŸ¦•</div><div><div class="tradeoff-title">Deno (backend) vs Node.js everywhere</div><div class="tradeoff-subtitle">Developer experience vs ecosystem breadth</div></div></div><div class="tradeoff-body">Deno 2 for backend services gives native TypeScript, built-in security, and a lean toolchain. Node.js remains for Next.js (Deno not yet compatible).</div><div class="pro-con"><div class="pro"><div class="pro-title">Deno Pros</div><ul><li>No tsconfig / ts-node</li><li>Deny-by-default security</li><li>Built-in fmt/lint/test</li></ul></div><div class="con"><div class="con-title">Cons</div><ul><li>Some npm packages incompatible</li><li>Mixed runtimes in monorepo</li><li>Smaller hiring pool</li></ul></div></div></div>
      <div class="tradeoff-card" style="grid-column:1/-1;"><div class="tradeoff-header"><div class="tradeoff-icon" style="background:rgba(0,196,255,0.1)">ğŸªœ</div><div><div class="tradeoff-title">Migration: Big Bang vs Incremental</div><div class="tradeoff-subtitle">Risk vs speed</div></div></div><div class="tradeoff-body" style="margin-bottom:12px;">Run both systems in parallel briefly, migrate tenants in waves starting with internal users, use feature flags to toggle per tenant.</div><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;"><div style="background:var(--surface2);border-radius:6px;padding:11px;border-top:2px solid var(--accent)"><div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:3px;">Phase 1</div><div style="font-size:11px;color:var(--text-muted)">Build new platform Â· Internal users only</div></div><div style="background:var(--surface2);border-radius:6px;padding:11px;border-top:2px solid var(--accent2)"><div style="font-size:11px;font-weight:700;color:var(--accent2);margin-bottom:3px;">Phase 2</div><div style="font-size:11px;color:var(--text-muted)">Pilot external tenants Â· Feature flag toggle</div></div><div style="background:var(--surface2);border-radius:6px;padding:11px;border-top:2px solid var(--accent3)"><div style="font-size:11px;font-weight:700;color:var(--accent3);margin-bottom:3px;">Phase 3</div><div style="font-size:11px;color:var(--text-muted)">Wave migration of remaining tenants</div></div><div style="background:var(--surface2);border-radius:6px;padding:11px;border-top:2px solid var(--accent4)"><div style="font-size:11px;font-weight:700;color:var(--accent4);margin-bottom:3px;">Phase 4</div><div style="font-size:11px;color:var(--text-muted)">Decommission Reporting Hub</div></div></div></div>
    </div>
  </div>

  <!-- â•â• SCALABILITY â•â• -->
  <div class="panel" id="panel-scalability">
    <p style="color:var(--text-dim);font-size:14px;margin-bottom:24px;line-height:1.6;">The two scalability concerns that will matter earliest and most:</p>
    <div class="scale-grid">
      <div class="scale-card" style="border-top:2px solid var(--accent)"><div class="scale-header"><div class="scale-dot" style="background:var(--accent)"></div>Power BI Capacity Costs</div><div class="scale-item"><div class="scale-item-title">The problem</div><div class="scale-item-desc">A-SKU is billed by reserved capacity, not per-user. An A1 (~$735/mo) supports ~300 concurrent renders. Heavy usage or many tenants scales costs fast.</div></div><div class="scale-item"><div class="scale-item-title">Mitigation: Embed token caching</div><div class="scale-item-desc">Cache tokens in Redis for 45 minutes. Avoids hitting the PBI API on every page load. Reduces latency and rate limit exposure significantly.</div></div><div class="scale-item"><div class="scale-item-title">Long-term: Native chart migration</div><div class="scale-item-desc">For simple, high-volume reports, native charts eliminate the A-SKU cost entirely. Identify candidates early.</div></div></div>
      <div class="scale-card" style="border-top:2px solid var(--accent3)"><div class="scale-header"><div class="scale-dot" style="background:var(--accent3)"></div>Multi-tenant Data Isolation</div><div class="scale-item"><div class="scale-item-title">The problem</div><div class="scale-item-desc">As tenant count grows, a poorly designed tenancy model creates noisy-neighbour problems, security risk, and painful migrations.</div></div><div class="scale-item"><div class="scale-item-title">Shared DB + Postgres RLS</div><div class="scale-item-desc">Single Postgres DB with tenantId on all tables. RLS policies enforce isolation at the DB layer â€” even if application code has a bug.</div></div><div class="scale-item"><div class="scale-item-title">Connection pooling</div><div class="scale-item-desc">PgBouncer in transaction mode. At scale, naive connection-per-request kills Postgres. Pool and reuse aggressively.</div></div></div>
      <div class="scale-card" style="border-top:2px solid var(--accent4)"><div class="scale-header"><div class="scale-dot" style="background:var(--accent4)"></div>Auth at Scale</div><div class="scale-item"><div class="scale-item-title">Token validation</div><div class="scale-item-desc">JWT RS256 verify is ~0.1ms. Cache Auth0 JWKS public keys locally. Don't call Auth0 on every request â€” only on key rotation.</div></div><div class="scale-item"><div class="scale-item-title">Per-tenant rate limiting</div><div class="scale-item-desc">Redis-backed sliding window rate limits per tenant and per endpoint. Prevents one tenant degrading others.</div></div></div>
      <div class="scale-card" style="border-top:2px solid var(--accent2)"><div class="scale-header"><div class="scale-dot" style="background:var(--accent2)"></div>Observability from Day 1</div><div class="scale-item"><div class="scale-item-title">Why it matters early</div><div class="scale-item-desc">Retrofitting observability is painful. Wire up structured logging (tenantId, userId on every log line), traces, and business metrics from the start.</div></div><div class="scale-item"><div class="scale-item-title">Key metrics</div><div class="scale-item-desc">Embed token latency Â· Report load time per tenant Â· Auth failure rate Â· PBI capacity utilisation Â· API error rates.</div></div></div>
    </div>
  </div>

  <!-- â•â• DENO NOTES â•â• -->
  <div class="panel" id="panel-deno">
    <div style="background:rgba(0,196,255,0.06);border:1px solid rgba(0,196,255,0.2);border-radius:10px;padding:14px 18px;margin-bottom:24px;display:flex;align-items:center;gap:12px;">
      <div style="font-size:22px;">ğŸ¦•</div>
      <div>
        <div style="font-size:12px;font-weight:600;color:var(--accent);margin-bottom:3px;">Deno Runtime â€” Project Notes</div>
        <div style="font-size:13px;color:var(--text-dim);">This project uses <strong style="color:var(--text)">Deno 2</strong> as the JavaScript runtime for all backend services. Deno replaces Node.js+npm for the API tier â€” native TypeScript, deny-by-default security, and zero build config.</div>
      </div>
    </div>

    <div class="scale-grid">

      <div class="scale-card" style="border-top:2px solid var(--accent)">
        <div class="scale-header"><div class="scale-dot" style="background:var(--accent)"></div>Why Deno for This Project</div>
        <div class="scale-item">
          <div class="scale-item-title">Native TypeScript â€” zero config</div>
          <div class="scale-item-desc">Deno runs <span class="tech-badge green">.ts</span> files directly. No tsconfig.json, no ts-node, no compile step during development. All backend services (Core API, Embed Token Service, Tenant Service, AI Service) are pure TypeScript executed directly by Deno 2.</div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">Secure by default â€” principle of least privilege</div>
          <div class="scale-item-desc">Deno denies all I/O by default and requires explicit permission flags. The Embed Token Service runs with only <span class="tech-badge primary">--allow-net</span> and <span class="tech-badge primary">--allow-env</span> â€” it physically cannot touch the filesystem or spawn processes. This aligns perfectly with the security posture required for a PBI credential handler.</div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">Built-in toolchain eliminates setup</div>
          <div class="scale-item-desc">Deno ships <span class="tech-badge">deno fmt</span> (Prettier replacement), <span class="tech-badge">deno lint</span> (ESLint replacement), <span class="tech-badge">deno test</span> (Jest replacement), and <span class="tech-badge">deno compile</span> for single-binary builds. Removes 4 dev-dependencies from every backend service.</div>
        </div>
      </div>

      <div class="scale-card" style="border-top:2px solid var(--accent3)">
        <div class="scale-header"><div class="scale-dot" style="background:var(--accent3)"></div>npm Compatibility (Deno 2)</div>
        <div class="scale-item">
          <div class="scale-item-title">npm: specifiers work natively</div>
          <div class="scale-item-desc">Deno 2 supports <span class="tech-badge green">npm:package-name</span> imports directly in source. Key packages in this project: <span class="tech-badge green">npm:fastify</span> Â· <span class="tech-badge green">npm:drizzle-orm</span> Â· <span class="tech-badge green">npm:ioredis</span> Â· <span class="tech-badge green">npm:zod</span>. No node_modules folder, no install step needed â€” Deno caches to DENO_DIR on first run.</div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">deno.json replaces package.json</div>
          <div class="scale-item-desc">Each service has a <span class="tech-badge">deno.json</span> declaring the imports map, task scripts, and lint/fmt config. Version pinning via <span class="tech-badge">deno.lock</span> committed to git for reproducible CI builds.</div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">JSR for Deno-native packages</div>
          <div class="scale-item-desc">Prefer <span class="tech-badge green">jsr:@std/</span> for standard library modules: HTTP helpers, assertions, structured logging, CSV/JSON parsing. Fall back to <span class="tech-badge">npm:</span> only when no JSR equivalent exists.</div>
        </div>
      </div>

      <div class="scale-card" style="border-top:2px solid var(--accent2)">
        <div class="scale-header"><div class="scale-dot" style="background:var(--accent2)"></div>Per-Service Permission Flags</div>
        <div class="scale-item">
          <div class="scale-item-title">Core API</div>
          <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;background:var(--bg);border:1px solid var(--border);padding:8px 10px;border-radius:5px;color:var(--accent3);margin-top:6px;line-height:1.8">deno run \<br>&nbsp;&nbsp;--allow-net \<br>&nbsp;&nbsp;--allow-env \<br>&nbsp;&nbsp;--allow-read=./config \<br>&nbsp;&nbsp;main.ts</div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">Embed Token Service</div>
          <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;background:var(--bg);border:1px solid var(--border);padding:8px 10px;border-radius:5px;color:var(--accent3);margin-top:6px;line-height:1.8">deno run \<br>&nbsp;&nbsp;--allow-net \<br>&nbsp;&nbsp;--allow-env \<br>&nbsp;&nbsp;main.ts<br><span style="color:var(--text-muted)"># No --allow-read: credentials via env only</span></div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">Tenant + AI Services</div>
          <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;background:var(--bg);border:1px solid var(--border);padding:8px 10px;border-radius:5px;color:var(--accent3);margin-top:6px;line-height:1.8">deno run \<br>&nbsp;&nbsp;--allow-net \<br>&nbsp;&nbsp;--allow-env \<br>&nbsp;&nbsp;--allow-read=./static \<br>&nbsp;&nbsp;main.ts</div>
        </div>
      </div>

      <div class="scale-card" style="border-top:2px solid var(--accent4)">
        <div class="scale-header"><div class="scale-dot" style="background:var(--accent4)"></div>Deno in Docker / ECS Fargate</div>
        <div class="scale-item">
          <div class="scale-item-title">Optimized Dockerfile pattern</div>
          <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;background:var(--bg);border:1px solid var(--border);padding:8px 10px;border-radius:5px;color:var(--accent3);margin-top:6px;line-height:1.8">FROM denoland/deno:2-alpine<br>WORKDIR /app<br><span style="color:var(--text-muted)"># Cache deps first (better layer caching)</span><br>COPY deno.json deno.lock ./<br>RUN deno cache main.ts<br><span style="color:var(--text-muted)"># Source copied after deps are cached</span><br>COPY . .<br>CMD ["deno","run","--allow-net","--allow-env","main.ts"]</div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">Image size advantage</div>
          <div class="scale-item-desc">Deno Alpine image: ~80 MB. Node.js Alpine: ~130 MB. Smaller images mean faster ECS task cold starts during autoscale events. No node_modules directory keeps the image lean even with many dependencies.</div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">Health checks unchanged</div>
          <div class="scale-item-desc">ECS health check config is identical to Node.js services â€” Deno's HTTP server listens on the same port and responds to the same ALB health check path. No task definition changes needed beyond swapping the base image.</div>
        </div>
      </div>

      <div class="scale-card" style="border-top:2px solid #f472b6">
        <div class="scale-header"><div class="scale-dot" style="background:#f472b6"></div>Next.js Frontend â€” Key Caveat</div>
        <div class="scale-item">
          <div class="scale-item-title">Next.js still runs on Node.js</div>
          <div class="scale-item-desc">Next.js App Router is <strong>not yet compatible with Deno</strong> as a runtime host. The frontend service continues to use Node.js 20 LTS in its own ECS container. Only the four backend services switch to Deno 2.</div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">Recommended monorepo layout</div>
          <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;background:var(--bg);border:1px solid var(--border);padding:8px 10px;border-radius:5px;color:var(--accent3);margin-top:6px;line-height:1.9">/apps<br>&nbsp;&nbsp;/web&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;â† Next.js&nbsp;&nbsp;&nbsp;(Node.js 20)<br>&nbsp;&nbsp;/api&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;â† Fastify&nbsp;&nbsp;&nbsp;(Deno 2)<br>&nbsp;&nbsp;/embed-svc&nbsp;&nbsp;&nbsp;&nbsp;â† PBI token (Deno 2)<br>&nbsp;&nbsp;/tenant-svc&nbsp;&nbsp;&nbsp;â† Config&nbsp;&nbsp;&nbsp;&nbsp;(Deno 2)<br>&nbsp;&nbsp;/ai-svc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;â† AI ops&nbsp;&nbsp;&nbsp;&nbsp;(Deno 2)<br>/packages<br>&nbsp;&nbsp;/types&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;â† Shared TS types (JSR)</div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">Shared types across runtimes</div>
          <div class="scale-item-desc">Publish shared TypeScript interfaces to <span class="tech-badge green">jsr:@sapiant/types</span>. Both Next.js (via npm compat layer) and Deno services import from the same JSR source â€” no type drift between frontend contracts and backend API shapes.</div>
        </div>
      </div>

      <div class="scale-card" style="border-top:2px solid var(--accent)">
        <div class="scale-header"><div class="scale-dot" style="background:var(--accent)"></div>deno.json â€” Full Reference</div>
        <div class="scale-item">
          <div class="scale-item-title">Example â€” Core API service</div>
          <div style="font-family:'IBM Plex Mono',monospace;font-size:11px;background:var(--bg);border:1px solid var(--border);padding:8px 10px;border-radius:5px;color:var(--accent3);margin-top:6px;line-height:1.8">{<br>&nbsp;&nbsp;"tasks": {<br>&nbsp;&nbsp;&nbsp;&nbsp;"dev":&nbsp;&nbsp;&nbsp;"deno run --watch --allow-net --allow-env main.ts",<br>&nbsp;&nbsp;&nbsp;&nbsp;"start": "deno run --allow-net --allow-env main.ts",<br>&nbsp;&nbsp;&nbsp;&nbsp;"test":&nbsp;&nbsp;"deno test --allow-net --allow-env",<br>&nbsp;&nbsp;&nbsp;&nbsp;"check": "deno check main.ts",<br>&nbsp;&nbsp;&nbsp;&nbsp;"lint":&nbsp;&nbsp;"deno lint",<br>&nbsp;&nbsp;&nbsp;&nbsp;"fmt":&nbsp;&nbsp;&nbsp;"deno fmt --check"<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;"imports": {<br>&nbsp;&nbsp;&nbsp;&nbsp;"fastify":&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"npm:fastify@^4",<br>&nbsp;&nbsp;&nbsp;&nbsp;"zod":&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"npm:zod@^3",<br>&nbsp;&nbsp;&nbsp;&nbsp;"ioredis":&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"npm:ioredis@^5",<br>&nbsp;&nbsp;&nbsp;&nbsp;"@std/assert":&nbsp;&nbsp;&nbsp;"jsr:@std/assert@^1",<br>&nbsp;&nbsp;&nbsp;&nbsp;"@std/log":&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"jsr:@std/log@^0.224"<br>&nbsp;&nbsp;}<br>}</div>
        </div>
      </div>

    </div>

    <div style="margin-top:20px;background:var(--surface);border:1px solid var(--accent4);border-radius:10px;padding:18px;">
      <div style="font-size:12px;font-weight:600;color:var(--accent4);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:12px;">âš ï¸ Known Gotchas to Address Early</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div style="font-size:13px;color:var(--text-dim);line-height:1.6;padding:12px;background:var(--surface2);border-radius:8px;border-left:2px solid var(--accent5)">
          <strong style="color:var(--text)">Native addon packages</strong><br>
          Use <span class="tech-badge green" style="font-size:10px;padding:1px 6px">npm:postgres</span> (pure-JS) instead of <span class="tech-badge" style="font-size:10px;padding:1px 6px">npm:pg</span> which has N-API native bindings that don't run under Deno. Same for bcrypt â€” prefer <span class="tech-badge green" style="font-size:10px;padding:1px 6px">jsr:@denosaurs/bcrypt</span>. Audit each npm package before adopting it.
        </div>
        <div style="font-size:13px;color:var(--text-dim);line-height:1.6;padding:12px;background:var(--surface2);border-radius:8px;border-left:2px solid var(--accent5)">
          <strong style="color:var(--text)">AWS SDK v3 compatibility</strong><br>
          Most <span class="tech-badge" style="font-size:10px;padding:1px 6px">@aws-sdk/client-*</span> packages work under Deno, but some sub-packages use Node.js built-ins. Add <span class="tech-badge primary" style="font-size:10px;padding:1px 6px">--allow-sys</span> if you hit permission errors. Test S3 and Secrets Manager clients explicitly before committing to the setup.
        </div>
        <div style="font-size:13px;color:var(--text-dim);line-height:1.6;padding:12px;background:var(--surface2);border-radius:8px;border-left:2px solid var(--accent4)">
          <strong style="color:var(--text)">CI/CD module caching</strong><br>
          Set <span class="tech-badge amber" style="font-size:10px;padding:1px 6px">DENO_DIR=/root/.deno-cache</span> and cache that path in CodeBuild / GitHub Actions. Without caching, every pipeline run re-downloads all modules â€” adds 30â€“60 s per service and unnecessary egress cost from npm/JSR registries.
        </div>
        <div style="font-size:13px;color:var(--text-dim);line-height:1.6;padding:12px;background:var(--surface2);border-radius:8px;border-left:2px solid var(--accent4)">
          <strong style="color:var(--text)">Unstable API flags</strong><br>
          Some Deno APIs still require <span class="tech-badge" style="font-size:10px;padding:1px 6px">--unstable-kv</span>, <span class="tech-badge" style="font-size:10px;padding:1px 6px">--unstable-cron</span>, etc. We don't currently use any. Audit before adopting new Deno-native features â€” don't ship unstable APIs to production without verifying the Deno team's stability commitment for that API.
        </div>
      </div>
    </div>
  </div>


  <!-- â•â• TENANT ISOLATION â•â• -->
  <div class="panel" id="panel-tenancy">
    <p style="color:var(--text-dim);font-size:14px;margin-bottom:24px;line-height:1.6;">Multi-tenancy is the most consequential architectural decision in this system. It affects cost, security, compliance, operational complexity, and how Power BI workspaces are structured. Here are the three models and the recommended choice:</p>

    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:32px;">
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;opacity:0.65;">
        <div style="background:rgba(239,68,68,0.08);border-bottom:1px solid var(--border);padding:14px 18px;">
          <div style="font-size:10px;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent5);margin-bottom:4px;">Option A â€” Not Recommended</div>
          <div style="font-size:15px;font-weight:700;">Schema-per-Tenant</div>
          <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">Strongest isolation, worst ops</div>
        </div>
        <div style="padding:16px 18px;">
          <div style="font-size:12px;color:var(--text-dim);line-height:1.6;margin-bottom:12px;">Separate Postgres schema per tenant. Strongest isolation but requires schema migrations across N tenants on every deploy.</div>
          <div class="pro-con">
            <div class="pro"><div class="pro-title">Pros</div><ul><li>Hard data boundary</li><li>Easier compliance stories</li><li>Simple per-tenant backup</li></ul></div>
            <div class="con"><div class="con-title">Cons</div><ul><li>Migrations run NÃ— per deploy</li><li>Connection pool explosion</li><li>Expensive at 200 tenants</li><li>Can't query across tenants</li></ul></div>
          </div>
        </div>
      </div>

      <div style="background:var(--surface);border:2px solid var(--accent3);border-radius:12px;overflow:hidden;position:relative;">
        <div style="position:absolute;top:12px;right:12px;background:var(--accent3);color:#000;font-size:10px;font-weight:700;padding:2px 8px;border-radius:4px;font-family:'IBM Plex Mono',monospace;">RECOMMENDED</div>
        <div style="background:rgba(16,185,129,0.08);border-bottom:1px solid var(--border);padding:14px 18px;">
          <div style="font-size:10px;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent3);margin-bottom:4px;">Option B â€” Recommended</div>
          <div style="font-size:15px;font-weight:700;">Shared DB + Postgres RLS</div>
          <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">Balanced â€” strong isolation, simple ops</div>
        </div>
        <div style="padding:16px 18px;">
          <div style="font-size:12px;color:var(--text-dim);line-height:1.6;margin-bottom:12px;">Single database, every table has a <code style="font-family:'IBM Plex Mono',monospace;font-size:10px;background:var(--surface2);border:1px solid var(--border);padding:1px 5px;border-radius:3px;color:var(--accent3)">tenant_id</code> column. Postgres Row-Level Security policies enforce isolation at the DB layer â€” even a buggy query can't leak cross-tenant data.</div>
          <div class="pro-con">
            <div class="pro"><div class="pro-title">Pros</div><ul><li>One migration per deploy</li><li>Low infra cost</li><li>Cross-tenant analytics possible</li><li>Defence in depth via DB RLS</li></ul></div>
            <div class="con"><div class="con-title">Cons</div><ul><li>Requires discipline on every query</li><li>Noisy-neighbour risk without connection limits</li></ul></div>
          </div>
        </div>
      </div>

      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;opacity:0.65;">
        <div style="background:rgba(245,158,11,0.08);border-bottom:1px solid var(--border);padding:14px 18px;">
          <div style="font-size:10px;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent4);margin-bottom:4px;">Option C â€” Future Option</div>
          <div style="font-size:15px;font-weight:700;">DB-per-Tenant</div>
          <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">Max isolation, max cost</div>
        </div>
        <div style="padding:16px 18px;">
          <div style="font-size:12px;color:var(--text-dim);line-height:1.6;margin-bottom:12px;">Separate RDS instance per tenant. Makes sense only for very high-value enterprise clients with contractual data isolation requirements.</div>
          <div class="pro-con">
            <div class="pro"><div class="pro-title">Pros</div><ul><li>Hard contractual boundary</li><li>Per-tenant encryption keys</li><li>Independent scaling</li></ul></div>
            <div class="con"><div class="con-title">Cons</div><ul><li>~$50+/mo per tenant just for DB</li><li>200 tenants = complex fleet mgmt</li><li>Cannot be retrofitted easily</li></ul></div>
          </div>
        </div>
      </div>
    </div>

    <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:22px;margin-bottom:24px;">
      <div style="font-size:11px;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:0.12em;color:var(--accent3);margin-bottom:16px;">How Shared DB + Postgres RLS Works in Practice</div>
      <div class="rls-flow">
        <div class="rls-step">
          <div class="rls-num" style="background:rgba(16,185,129,0.1);border:1px solid var(--accent3);color:var(--accent3)">1</div>
          <div class="rls-step-content">
            <h4>Every table has tenant_id</h4>
            <p>Schema convention: every application table includes a non-nullable <code>tenant_id UUID REFERENCES tenants(id)</code>. Enforced by Drizzle ORM schema definitions at code level.</p>
          </div>
        </div>
        <div class="rls-step">
          <div class="rls-num" style="background:rgba(16,185,129,0.1);border:1px solid var(--accent3);color:var(--accent3)">2</div>
          <div class="rls-step-content">
            <h4>Postgres RLS policy on every table</h4>
            <p>At the DB layer, an RLS policy filters all reads and writes. Even a raw SQL query bypassing the ORM can't see another tenant's data.</p>
            <code>CREATE POLICY tenant_isolation ON reports USING (tenant_id = current_setting('app.tenant_id')::uuid);</code>
          </div>
        </div>
        <div class="rls-step">
          <div class="rls-num" style="background:rgba(16,185,129,0.1);border:1px solid var(--accent3);color:var(--accent3)">3</div>
          <div class="rls-step-content">
            <h4>API middleware sets tenant context per request</h4>
            <p>On every request, the middleware extracts tenantId from the verified JWT and sets it as a Postgres session variable before any query runs.</p>
            <code>SET LOCAL app.tenant_id = '${req.user.tenantId}';</code>
          </div>
        </div>
        <div class="rls-step">
          <div class="rls-num" style="background:rgba(16,185,129,0.1);border:1px solid var(--accent3);color:var(--accent3)">4</div>
          <div class="rls-step-content">
            <h4>Admin bypass for internal operations</h4>
            <p>A separate <code>app_admin</code> DB role with RLS bypassed is used only for migrations and internal tooling. Application services use a <code>app_user</code> role with RLS enabled â€” no exceptions.</p>
          </div>
        </div>
      </div>
    </div>

    <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:22px;">
      <div style="font-size:11px;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:0.12em;color:var(--accent);margin-bottom:16px;">Power BI Tenant Isolation â€” Workspace Strategy</div>
      <p style="font-size:13px;color:var(--text-dim);line-height:1.6;margin-bottom:16px;">The Power BI workspace structure is a separate but equally important decision. There are two main approaches:</p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:16px;border-top:2px solid var(--accent2);">
          <div style="font-size:12px;font-weight:700;color:var(--accent2);margin-bottom:8px;">Option: One workspace per tenant</div>
          <div style="font-size:12px;color:var(--text-muted);line-height:1.5;margin-bottom:10px;">Each tenant gets its own Power BI workspace. Reports and datasets are isolated by workspace boundary â€” no RLS needed for tenant separation (though RLS still used for row-level user permissions within a tenant).</div>
          <div style="font-size:11px;"><span style="color:var(--accent3)">âœ“</span> Hardest isolation boundary possible<br><span style="color:var(--accent3)">âœ“</span> Clean workspace management per tenant<br><span style="color:var(--accent5)">âœ—</span> Workspace provisioning automation needed<br><span style="color:var(--accent5)">âœ—</span> Report updates must be pushed to each workspace</div>
        </div>
        <div style="background:var(--surface2);border:1px solid var(--accent3);border-radius:8px;padding:16px;border-top:2px solid var(--accent3);position:relative;">
          <div style="position:absolute;top:10px;right:10px;background:var(--accent3);color:#000;font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;font-family:'IBM Plex Mono',monospace;">RECOMMENDED</div>
          <div style="font-size:12px;font-weight:700;color:var(--accent3);margin-bottom:8px;">Option: Shared workspace + RLS</div>
          <div style="font-size:12px;color:var(--text-muted);line-height:1.5;margin-bottom:10px;">A small number of shared workspaces (one per report "type"). Tenant isolation is enforced entirely through the RLS identity we inject in the embed token. Simpler to manage and update reports.</div>
          <div style="font-size:11px;"><span style="color:var(--accent3)">âœ“</span> Fewer workspaces to manage<br><span style="color:var(--accent3)">âœ“</span> Report updates deploy once<br><span style="color:var(--accent3)">âœ“</span> Works well with our embed token service<br><span style="color:var(--accent5)">âœ—</span> Relies entirely on RLS correctness for isolation</div>
        </div>
      </div>
      <div style="margin-top:14px;padding:12px 16px;background:rgba(0,196,255,0.06);border:1px solid rgba(0,196,255,0.2);border-radius:8px;font-size:12px;color:var(--text-dim);line-height:1.6;">
        <strong style="color:var(--accent)">Our approach:</strong> Start with shared workspaces + RLS (simpler, faster to ship). Build workspace-per-tenant provisioning as an automation layer for any enterprise customers who contractually require hard workspace isolation. The Tenant Service handles the mapping â€” the embed service doesn't need to change, just the config it reads.
      </div>
    </div>
  </div>

  <!-- â•â• OBSERVABILITY â•â• -->
  <div class="panel" id="panel-observability-tab">
    <p style="color:var(--text-dim);font-size:14px;margin-bottom:24px;line-height:1.6;">The brief specifically calls out "clear observability, usage metrics, and monitoring" as a goal â€” and rightly so. This is a meaningful differentiator from Reporting Hub, which provides no visibility. Observability must be wired in from day one, not retrofitted.</p>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">
      <div class="scale-card" style="border-top:2px solid var(--accent);">
        <div class="scale-header"><div class="scale-dot" style="background:var(--accent)"></div>Infrastructure Observability</div>
        <div class="scale-item">
          <div class="scale-item-title">Structured logging â€” tenantId on every line</div>
          <div class="scale-item-desc">Every log emitted by every service includes <code style="font-family:'IBM Plex Mono',monospace;font-size:10px;background:var(--surface2);border:1px solid var(--border);padding:1px 5px;border-radius:3px;color:var(--accent3)">{ tenantId, userId, requestId, service, level, timestamp }</code>. This makes it possible to filter all logs for a specific tenant when debugging an issue, without needing to re-deploy or add instrumentation. Pino logger on the backend; forwarded to CloudWatch Logs + DataDog.</div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">Distributed tracing</div>
          <div class="scale-item-desc">OpenTelemetry traces span browser â†’ API â†’ DB â†’ Power BI REST API. When a user reports "the report was slow," we can see exactly where the latency was: embed token generation, Redis miss, PBI rendering, or network. DataDog APM or Grafana Tempo as the trace backend.</div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">Alerting thresholds</div>
          <div class="scale-item-desc">CloudWatch alarms page on-call when: API error rate &gt;1% for 5 minutes, embed token latency p99 &gt;2s, Power BI capacity &gt;80% utilisation, or auth failure rate spikes (potential credential stuffing).</div>
        </div>
      </div>

      <div class="scale-card" style="border-top:2px solid var(--accent3);">
        <div class="scale-header"><div class="scale-dot" style="background:var(--accent3)"></div>Application-Level Usage Metrics</div>
        <div class="scale-item">
          <div class="scale-item-title">Report usage analytics</div>
          <div class="scale-item-desc">Every report view, filter interaction, and export is logged as an event: <code style="font-family:'IBM Plex Mono',monospace;font-size:10px;background:var(--surface2);border:1px solid var(--border);padding:1px 5px;border-radius:3px;color:var(--accent3)">{ event: "report.viewed", tenantId, reportId, userId, durationMs }</code>. This lets us answer: Which reports are most used? Which tenants are most active? Which reports have high load times?</div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">Per-tenant usage dashboard</div>
          <div class="scale-item-desc">An internal admin view shows tenant health at a glance: MAU, DAU, report views, last login timestamps, feature flag states. Useful for customer success, renewals, and identifying at-risk tenants (low engagement = churn risk).</div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">Power BI capacity monitoring</div>
          <div class="scale-item-desc">The PBI REST API exposes capacity metrics. We poll and graph: CPU utilisation %, memory %, concurrent render count. This is the primary early warning for "we need to upgrade from A1 to A2" before users start experiencing timeouts.</div>
        </div>
      </div>

      <div class="scale-card" style="border-top:2px solid var(--accent2);">
        <div class="scale-header"><div class="scale-dot" style="background:var(--accent2)"></div>Security Monitoring</div>
        <div class="scale-item">
          <div class="scale-item-title">Audit log â€” all mutations recorded</div>
          <div class="scale-item-desc">Every write operation (user creation, role change, tenant config update, report mapping change) is written to an append-only <code style="font-family:'IBM Plex Mono',monospace;font-size:10px;background:var(--surface2);border:1px solid var(--border);padding:1px 5px;border-radius:3px;color:var(--accent3)">audit_log</code> table with actor, action, before/after values, and IP. Non-deletable. Queryable by tenant admins via the admin UI.</div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">Auth failure detection</div>
          <div class="scale-item-desc">Auth0 provides built-in anomaly detection. We additionally track failed embed token requests (could indicate a stolen JWT being replayed) and alert when any tenant sees an unusual spike in auth failures.</div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">Embed token abuse detection</div>
          <div class="scale-item-desc">Track embed token generation rate per user. A user generating hundreds of tokens rapidly is anomalous â€” could indicate an automated scraping attempt. Redis rate limiters block this before it reaches the Power BI API.</div>
        </div>
      </div>

      <div class="scale-card" style="border-top:2px solid var(--accent4);">
        <div class="scale-header"><div class="scale-dot" style="background:var(--accent4)"></div>Key Metrics to Track from Day 1</div>
        <div style="display:grid;gap:8px;">
          <div style="background:var(--surface2);border-radius:6px;padding:10px 12px;display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center;">
            <div style="font-size:18px;">âš¡</div>
            <div><div style="font-size:12px;font-weight:600;">Embed token latency</div><div style="font-size:11px;color:var(--text-muted);">Target: p50 &lt;200ms, p99 &lt;800ms. Cache hits should be &lt;5ms. PBI API cold calls ~500ms.</div></div>
          </div>
          <div style="background:var(--surface2);border-radius:6px;padding:10px 12px;display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center;">
            <div style="font-size:18px;">ğŸ“Š</div>
            <div><div style="font-size:12px;font-weight:600;">Report time-to-interactive</div><div style="font-size:11px;color:var(--text-muted);">Total time from user clicking a report page to PBI fully rendered. Target: &lt;3s. Drives A-SKU sizing decisions.</div></div>
          </div>
          <div style="background:var(--surface2);border-radius:6px;padding:10px 12px;display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center;">
            <div style="font-size:18px;">ğŸ¢</div>
            <div><div style="font-size:12px;font-weight:600;">Tenant config cache hit rate</div><div style="font-size:11px;color:var(--text-muted);">Should be &gt;95%. A drop signals Redis is evicting tenant configs â€” scale Redis or tune TTL.</div></div>
          </div>
          <div style="background:var(--surface2);border-radius:6px;padding:10px 12px;display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center;">
            <div style="font-size:18px;">ğŸ”‹</div>
            <div><div style="font-size:12px;font-weight:600;">PBI capacity utilisation %</div><div style="font-size:11px;color:var(--text-muted);">Alert at 70%, escalate at 85%. Gives time to upgrade SKU before users see failures.</div></div>
          </div>
          <div style="background:var(--surface2);border-radius:6px;padding:10px 12px;display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center;">
            <div style="font-size:18px;">ğŸ‘¥</div>
            <div><div style="font-size:12px;font-weight:600;">MAU / DAU per tenant</div><div style="font-size:11px;color:var(--text-muted);">Business health signal. Low engagement = churn risk. High growth = proactive capacity planning.</div></div>
          </div>
        </div>
      </div>
    </div>

    <div style="background:var(--surface);border:1px solid rgba(0,196,255,0.3);border-radius:10px;padding:18px;">
      <div style="font-size:12px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:8px;">Tooling Recommendation</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;font-size:12px;color:var(--text-dim);line-height:1.6;">
        <div><strong style="color:var(--text)">DataDog</strong> â€” Preferred option if budget allows. Combines APM, logs, metrics, dashboards, and alerts in one platform. Native ECS and Fargate integrations. Higher cost but significantly reduces operational overhead at scale.</div>
        <div><strong style="color:var(--text)">OpenTelemetry + Grafana</strong> â€” Lower cost alternative. OTel for instrumentation (vendor-neutral), Grafana for dashboards, Loki for logs, Tempo for traces. More setup time, but no vendor lock-in and essentially free at our scale.</div>
        <div><strong style="color:var(--text)">CloudWatch as baseline</strong> â€” Use regardless of the above. Container Insights for ECS metrics, Log Groups for all service logs, Alarms for critical thresholds. Zero additional cost beyond storage. Pair with one of the above for richer dashboards.</div>
      </div>
    </div>
  </div>

  <!-- â•â• NATIVE CHARTS â•â• -->
  <div class="panel" id="panel-native-charts">
    <div style="background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.25);border-radius:10px;padding:14px 18px;margin-bottom:24px;display:flex;align-items:center;gap:12px;">
      <div style="font-size:22px;">ğŸ’¡</div>
      <div>
        <div style="font-size:12px;font-weight:600;color:var(--accent4);margin-bottom:3px;">Optional â€” High-Value Long-Term Decision</div>
        <div style="font-size:13px;color:var(--text-dim);">Power BI Embedded A-SKU is a <strong style="color:var(--text)">flat monthly cost regardless of usage</strong>. At scale, migrating high-volume or simple reports to native charts eliminates that cost entirely. This isn't an urgent decision, but identifying candidates early saves significant money later.</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">
      <div class="scale-card" style="border-top:2px solid var(--accent4);">
        <div class="scale-header"><div class="scale-dot" style="background:var(--accent4)"></div>Why Consider It</div>
        <div class="scale-item">
          <div class="scale-item-title">The cost math</div>
          <div class="scale-item-desc">At A2 SKU (~$1,470/mo) with 200 tenants, that's ~$7.35/tenant/month just for rendering capacity â€” before any compute, DB, or auth costs. For tenants that only ever view 2â€“3 simple bar charts, this is expensive. Native charts for simple reports pay for themselves within months of dev effort.</div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">Design control</div>
          <div class="scale-item-desc">Power BI's visual style is constrained and corporate. Native charts let us match the platform's design system exactly â€” custom colours, typography, animations, and interactions that feel native to the product rather than embedded.</div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">Interactivity and AI integration</div>
          <div class="scale-item-desc">Native charts can respond to real-time data, AI-generated annotations, drilldowns that open application flows (e.g. clicking a revenue bar to open a CRUD form), and cross-chart state. These interactions are impossible or extremely limited in embedded Power BI.</div>
        </div>
      </div>

      <div class="scale-card" style="border-top:2px solid var(--accent5);">
        <div class="scale-header"><div class="scale-dot" style="background:var(--accent5)"></div>Why Not Rush It</div>
        <div class="scale-item">
          <div class="scale-item-title">Power BI reports are complex</div>
          <div class="scale-item-desc">Power BI reports often have complex DAX measures, calculated columns, relationships, and interactivity built up over years. Rebuilding them natively requires understanding each report deeply â€” not just its visuals. A poor native port is worse than the original.</div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">Stakeholder familiarity</div>
          <div class="scale-item-desc">Report authors and power users are used to Power BI's interaction model. Changing the chart library changes their mental model. Any migration needs to be validated against user acceptance criteria, not just technical correctness.</div>
        </div>
        <div class="scale-item">
          <div class="scale-item-title">Data access changes</div>
          <div class="scale-item-desc">Native charts query data directly from the backend API. This requires exposing the datasets Power BI currently reads via secure API endpoints â€” a non-trivial backend change that needs careful design to preserve RLS guarantees.</div>
        </div>
      </div>
    </div>

    <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:22px;margin-bottom:20px;">
      <div style="font-size:11px;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:0.12em;color:var(--accent3);margin-bottom:16px;">Where to Start â€” The Migration Framework</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;">
        <div style="background:var(--surface2);border-radius:8px;padding:14px;border-top:2px solid var(--accent);">
          <div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:6px;font-family:'IBM Plex Mono',monospace;">STEP 1</div>
          <div style="font-size:12px;font-weight:600;margin-bottom:4px;">Audit & Classify</div>
          <div style="font-size:11px;color:var(--text-muted);line-height:1.5;">Inventory all Power BI reports. Classify by complexity (simple/medium/complex) and usage volume. Identify the "quick win" candidates.</div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;padding:14px;border-top:2px solid var(--accent2);">
          <div style="font-size:11px;font-weight:700;color:var(--accent2);margin-bottom:6px;font-family:'IBM Plex Mono',monospace;">STEP 2</div>
          <div style="font-size:12px;font-weight:600;margin-bottom:4px;">Choose Library</div>
          <div style="font-size:11px;color:var(--text-muted);line-height:1.5;">Evaluate Recharts (simple, React-native), Nivo (beautiful, opinionated), or ECharts (feature-rich, complex). Run a spike with one real report from each candidate type.</div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;padding:14px;border-top:2px solid var(--accent3);">
          <div style="font-size:11px;font-weight:700;color:var(--accent3);margin-bottom:6px;font-family:'IBM Plex Mono',monospace;">STEP 3</div>
          <div style="font-size:12px;font-weight:600;margin-bottom:4px;">Pilot One Report</div>
          <div style="font-size:11px;color:var(--text-muted);line-height:1.5;">Build a native version of the highest-volume simple report alongside the PBI version. A/B test internally. Validate data parity, RLS correctness, and performance.</div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;padding:14px;border-top:2px solid var(--accent4);">
          <div style="font-size:11px;font-weight:700;color:var(--accent4);margin-bottom:6px;font-family:'IBM Plex Mono',monospace;">STEP 4</div>
          <div style="font-size:12px;font-weight:600;margin-bottom:4px;">Migrate in Waves</div>
          <div style="font-size:11px;color:var(--text-muted);line-height:1.5;">Roll out by report type. Track cost savings as each report migrates. Set a threshold: "when native covers 60% of report views, evaluate dropping a PBI SKU tier."</div>
        </div>
      </div>

      <div style="font-size:11px;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-muted);margin-bottom:12px;">Library Comparison</div>
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;font-size:12px;">
          <thead>
            <tr style="border-bottom:1px solid var(--border);">
              <th style="text-align:left;padding:8px 12px;color:var(--text-muted);font-weight:600;font-family:'IBM Plex Mono',monospace;font-size:10px;">Library</th>
              <th style="text-align:left;padding:8px 12px;color:var(--text-muted);font-weight:600;font-family:'IBM Plex Mono',monospace;font-size:10px;">Best For</th>
              <th style="text-align:left;padding:8px 12px;color:var(--text-muted);font-weight:600;font-family:'IBM Plex Mono',monospace;font-size:10px;">Complexity</th>
              <th style="text-align:left;padding:8px 12px;color:var(--text-muted);font-weight:600;font-family:'IBM Plex Mono',monospace;font-size:10px;">React Support</th>
              <th style="text-align:left;padding:8px 12px;color:var(--text-muted);font-weight:600;font-family:'IBM Plex Mono',monospace;font-size:10px;">Verdict</th>
            </tr>
          </thead>
          <tbody>
            <tr style="border-bottom:1px solid var(--border);">
              <td style="padding:10px 12px;font-weight:600;color:var(--accent3)">Recharts</td>
              <td style="padding:10px 12px;color:var(--text-dim)">Bar, line, area, pie â€” standard business charts</td>
              <td style="padding:10px 12px;color:var(--text-dim)">Low</td>
              <td style="padding:10px 12px;color:var(--accent3)">Native React âœ“</td>
              <td style="padding:10px 12px;color:var(--text-dim)">Start here. Covers 70% of typical dashboard charts with minimal effort.</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border);">
              <td style="padding:10px 12px;font-weight:600;color:var(--accent)">Nivo</td>
              <td style="padding:10px 12px;color:var(--text-dim)">Heatmaps, treemaps, sankey, network charts</td>
              <td style="padding:10px 12px;color:var(--text-dim)">Medium</td>
              <td style="padding:10px 12px;color:var(--accent3)">React âœ“</td>
              <td style="padding:10px 12px;color:var(--text-dim)">Beautiful defaults. Use for complex or unusual chart types where Recharts falls short.</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border);">
              <td style="padding:10px 12px;font-weight:600;color:var(--accent4)">ECharts</td>
              <td style="padding:10px 12px;color:var(--text-dim)">Large datasets, geo maps, financial charts</td>
              <td style="padding:10px 12px;color:var(--text-dim)">High</td>
              <td style="padding:10px 12px;color:var(--text-dim)">Via wrapper</td>
              <td style="padding:10px 12px;color:var(--text-dim)">Reserve for high-data-volume or geo reports. Most powerful, but heaviest to integrate.</td>
            </tr>
            <tr>
              <td style="padding:10px 12px;font-weight:600;color:var(--accent2)">D3</td>
              <td style="padding:10px 12px;color:var(--text-dim)">Custom / bespoke visualisations</td>
              <td style="padding:10px 12px;color:var(--text-dim)">Very High</td>
              <td style="padding:10px 12px;color:var(--text-dim)">Manual integration</td>
              <td style="padding:10px 12px;color:var(--text-dim)">Only if a report type can't be done in Recharts/Nivo. Avoid as primary library.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div style="background:var(--surface);border:1px solid rgba(16,185,129,0.3);border-radius:10px;padding:16px 18px;">
      <div style="font-size:12px;font-weight:600;color:var(--accent3);margin-bottom:8px;">Recommended starting point for this project</div>
      <div style="font-size:13px;color:var(--text-dim);line-height:1.6;">Start with <strong style="color:var(--text)">Recharts</strong> for the first native chart pilot. It's React-native, has excellent TypeScript types, and covers standard business chart types that are likely the easiest PBI reports to migrate. Run the pilot on a high-volume, low-complexity report (e.g. a monthly KPI summary with bar + line charts). If the pilot proves the pattern, expand. Don't make the final library decision until you've run that spike â€” the data shapes and interactivity requirements of real reports will clarify which library fits best.</div>
    </div>
  </div>

  <!-- â•â• WHY THESE CHOICES â•â• -->
  <div class="panel" id="panel-why-choices">
    <p style="color:var(--text-dim);font-size:14px;margin-bottom:24px;line-height:1.6;">Architecture is about decisions, not just components. Here's the explicit reasoning behind each significant technology choice â€” and what was rejected and why.</p>

    <div style="display:grid;gap:14px;">

      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;">
        <div style="display:grid;grid-template-columns:220px 1fr 1fr;border-bottom:1px solid var(--border);">
          <div style="padding:14px 18px;background:rgba(0,196,255,0.04);border-right:1px solid var(--border);">
            <div style="font-size:10px;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent);margin-bottom:4px;">Frontend</div>
            <div style="font-size:15px;font-weight:700;">Next.js + React</div>
            <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">Chosen âœ“</div>
          </div>
          <div style="padding:14px 18px;border-right:1px solid var(--border);">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--accent3);margin-bottom:6px;">Why Next.js</div>
            <div style="font-size:12px;color:var(--text-dim);line-height:1.6;">SSR gives fast first-load for report pages â€” critical for perceived performance. App Router supports nested tenant-specific layouts cleanly. Server Actions allow secure server-side operations (like auth checks) without a separate API hop. The Power BI embed SDK integrates as a Client Component while the shell is server-rendered. Single deployable unit keeps early-stage ops simple.</div>
          </div>
          <div style="padding:14px 18px;">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--accent5);margin-bottom:6px;">What was considered and rejected</div>
            <div style="font-size:12px;color:var(--text-dim);line-height:1.6;"><strong style="color:var(--text)">Remix:</strong> Strong SSR story but smaller ecosystem and less Power BI SDK documentation. <strong style="color:var(--text)">SvelteKit:</strong> Lighter weight but team retraining cost and fewer UI component libraries. <strong style="color:var(--text)">Vite SPA:</strong> No SSR â€” PBI embed pages would show blank content until JS hydrates, which is a bad experience on first load.</div>
          </div>
        </div>
      </div>

      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;">
        <div style="display:grid;grid-template-columns:220px 1fr 1fr;border-bottom:1px solid var(--border);">
          <div style="padding:14px 18px;background:rgba(124,58,237,0.04);border-right:1px solid var(--border);">
            <div style="font-size:10px;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent2);margin-bottom:4px;">Identity</div>
            <div style="font-size:15px;font-weight:700;">Auth0</div>
            <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">Chosen âœ“ (or Azure AD B2C)</div>
          </div>
          <div style="padding:14px 18px;border-right:1px solid var(--border);">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--accent3);margin-bottom:6px;">Why a managed IdP</div>
            <div style="font-size:12px;color:var(--text-dim);line-height:1.6;">Building authentication correctly â€” MFA, PKCE, refresh token rotation, enterprise SAML/OIDC connectors, brute-force protection â€” takes months and is a permanent maintenance liability. Auth0 gives all of this on day one. For a multi-tenant SaaS where enterprise customers will want SSO with their own identity provider (Azure AD, Okta, Google Workspace), a managed IdP with enterprise connections is almost mandatory. Auth0's free tier (7,500 MAU) covers the launch phase at zero cost.</div>
          </div>
          <div style="padding:14px 18px;">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--accent5);margin-bottom:6px;">Auth0 vs Azure AD B2C</div>
            <div style="font-size:12px;color:var(--text-dim);line-height:1.6;"><strong style="color:var(--text)">Choose Auth0</strong> if the team has no existing Microsoft dependency and wants the best DX for custom login flows and social connections. <strong style="color:var(--text)">Choose Azure AD B2C</strong> if the team is already in Azure (consolidating billing, using Azure DevOps, etc.) â€” its 50,000 MAU free tier is much larger, and keeping everything in the Microsoft ecosystem simplifies the Power BI service principal relationship. Either is a defensible choice; the decision should follow where the team's Azure relationship already is.</div>
          </div>
        </div>
      </div>

      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;">
        <div style="display:grid;grid-template-columns:220px 1fr 1fr;border-bottom:1px solid var(--border);">
          <div style="padding:14px 18px;background:rgba(16,185,129,0.04);border-right:1px solid var(--border);">
            <div style="font-size:10px;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent3);margin-bottom:4px;">Backend Runtime</div>
            <div style="font-size:15px;font-weight:700;">Deno 2</div>
            <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">Chosen âœ“ for API services</div>
          </div>
          <div style="padding:14px 18px;border-right:1px solid var(--border);">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--accent3);margin-bottom:6px;">Why Deno for backend services</div>
            <div style="font-size:12px;color:var(--text-dim);line-height:1.6;">The Embed Token Service handles Azure AD credentials and Power BI API calls â€” the most security-sensitive code in the system. Deno's deny-by-default permission model means the service physically cannot touch the filesystem or make unintended network calls unless explicitly permitted. Native TypeScript eliminates the tsconfig + ts-node build chain for all backend services. The Deno 2 npm compatibility layer means we're not giving up the npm ecosystem â€” Fastify, Drizzle, Zod, ioredis all work.</div>
          </div>
          <div style="padding:14px 18px;">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--accent5);margin-bottom:6px;">Why not Node.js everywhere</div>
            <div style="font-size:12px;color:var(--text-dim);line-height:1.6;">Node.js is the safe default and perfectly valid. The reason to consider Deno specifically for the Embed Token Service is the security model â€” a Node.js process with a compromised dependency can exfiltrate files, environment variables, and make arbitrary network calls. Deno's permission flags are a meaningful security control for a credential-handling process. The tradeoff: smaller hiring pool and occasional npm compatibility issues. For teams with strong Node.js experience and no appetite for runtime experimentation, using Node.js everywhere is a completely reasonable alternative.</div>
          </div>
        </div>
      </div>

      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;">
        <div style="display:grid;grid-template-columns:220px 1fr 1fr;border-bottom:1px solid var(--border);">
          <div style="padding:14px 18px;background:rgba(245,158,11,0.04);border-right:1px solid var(--border);">
            <div style="font-size:10px;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:0.1em;color:var(--accent4);margin-bottom:4px;">Compute</div>
            <div style="font-size:15px;font-weight:700;">ECS Fargate</div>
            <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">Chosen âœ“</div>
          </div>
          <div style="padding:14px 18px;border-right:1px solid var(--border);">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--accent3);margin-bottom:6px;">Why Fargate</div>
            <div style="font-size:12px;color:var(--text-dim);line-height:1.6;">The platform needs to run long-lived HTTP servers (Next.js SSR, Fastify API) â€” not short invocations. Fargate runs Docker containers without managing EC2 instances: no patching, no cluster management, no capacity reservations on the compute layer. ECS task definitions map cleanly to the per-service Docker images. Auto-scaling policies respond to CPU and memory, right-sizing for bursty traffic patterns. Deployments are blue-green with automatic rollback on health check failure.</div>
          </div>
          <div style="padding:14px 18px;">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--accent5);margin-bottom:6px;">What was considered and rejected</div>
            <div style="font-size:12px;color:var(--text-dim);line-height:1.6;"><strong style="color:var(--text)">Lambda:</strong> Cold starts are problematic for SSR and embed token generation (users notice 2â€“3s delays). Good for async jobs (report exports, dataset refresh triggers) but not request-response paths. <strong style="color:var(--text)">Kubernetes (EKS):</strong> Operationally heavier than needed at this scale. Fargate's simplicity is the right tradeoff until the team needs Kubernetes-specific features (custom scheduling, service meshes, etc.). <strong style="color:var(--text)">EC2:</strong> More control, more management burden. Fargate is the right abstraction level.</div>
          </div>
        </div>
      </div>

      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;">
        <div style="display:grid;grid-template-columns:220px 1fr 1fr;">
          <div style="padding:14px 18px;background:rgba(244,114,182,0.04);border-right:1px solid var(--border);">
            <div style="font-size:10px;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:0.1em;color:#f472b6;margin-bottom:4px;">Database</div>
            <div style="font-size:15px;font-weight:700;">PostgreSQL</div>
            <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">Chosen âœ“</div>
          </div>
          <div style="padding:14px 18px;border-right:1px solid var(--border);">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--accent3);margin-bottom:6px;">Why PostgreSQL</div>
            <div style="font-size:12px;color:var(--text-dim);line-height:1.6;">The application data â€” tenants, users, roles, navigation trees, audit logs â€” is relational. Postgres is the right tool. Critically, Postgres Row-Level Security gives us a database-layer enforcement of tenant isolation that acts as a safety net below the application layer. JSONB support covers the flexible, schema-light parts of tenant config (navigation trees, feature flags) without needing a separate document store. RDS Multi-AZ handles failover automatically.</div>
          </div>
          <div style="padding:14px 18px;">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--accent5);margin-bottom:6px;">What was considered and rejected</div>
            <div style="font-size:12px;color:var(--text-dim);line-height:1.6;"><strong style="color:var(--text)">MongoDB/DynamoDB:</strong> NoSQL is attractive for tenant config (flexible schema) but loses Postgres RLS â€” meaning tenant isolation is enforced only at application layer. For a multi-tenant SaaS handling sensitive customer data, losing a DB-layer isolation guarantee is a meaningful security regression. <strong style="color:var(--text)">PlanetScale/Neon:</strong> Interesting serverless Postgres options but add complexity for a team that already knows RDS. Start with RDS, explore alternatives later if connection pooling or branching become compelling.</div>
          </div>
        </div>
      </div>

    </div>
  </div>

</div><!-- /container -->

<div class="backdrop" id="backdrop" onclick="closeDetail()"></div>
<div class="detail-panel" id="detail-panel">
  <button class="detail-close" onclick="closeDetail()">âœ• close</button>
  <div id="detail-content"></div>
</div>

<script>
function showPanel(name,btn){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('panel-'+name).classList.add('active');
  if(btn)btn.classList.add('active');
}

const details={
  nextjs:{tag:'Client Tier',title:'Next.js Frontend',desc:'The core of the user-facing application. SSR for fast initial loads, React Server Components for reduced bundle size, App Router for clean nested routing perfect for multi-tenant nav hierarchy.',points:['App Router with nested layouts â€” one per tenant branding context','Server Components for auth-protected pages â€” token validated server-side','Client Components only where interactivity is needed','TypeScript throughout â€” catches tenant/role context bugs at compile time'],tech:['Next.js 14+','React 18','TypeScript','App Router','Server Actions'],techColor:'primary'},
  'pbi-embed':{tag:'Client Tier',title:'Power BI Embed SDK',desc:'powerbi-client-react handles report rendering. It takes an embed token from our backend and communicates directly with Power BI. RLS is enforced by Microsoft â€” the browser never sees raw data.',points:['Receives short-lived embed token from our backend only','Renders report in a sandboxed context','Supports token refresh without page reload','Event hooks for load state, errors, and interactions we can log'],tech:['powerbi-client-react','powerbi-models','Embed Token API'],techColor:'primary'},
  ui:{tag:'Client Tier',title:'Design System',desc:'Consistent, high-quality component library on Tailwind and Radix primitives. Enables the "polished UI/UX" goal â€” every component is accessible, themeable per tenant, and consistent.',points:['Tailwind CSS â€” easy to theme per tenant via CSS variables','shadcn/ui + Radix for accessible primitives','Framer Motion for transitions and micro-interactions','Tenant branding applied via CSS custom properties at layout level'],tech:['Tailwind CSS','shadcn/ui','Radix UI','Framer Motion'],techColor:'primary'},
  auth0:{tag:'Identity & Auth',title:'Auth0 / Azure AD B2C',desc:'Managed identity provider giving us MFA, SSO, enterprise IdP connectors (SAML, Azure AD, Google Workspace), and compliance-grade security without building from scratch.',points:['OIDC / OAuth 2.0 â€” industry standard','JWT on login: user ID, email, tenantId, roles','MFA enforceable per tenant policy','SSO: enterprise customers bring their own IdP'],tech:['Auth0','Azure AD B2C','OIDC','OAuth 2.0','SAML'],techColor:'purple'},
  rbac:{tag:'Identity & Auth',title:'RBAC + Tenant Context',desc:'Role-based access control + tenant isolation. Every request carries tenant ID and our backend enforces users only access their own tenant\'s data.',points:['Roles: Admin, Viewer, Editor (extensible per tenant)','Tenant ID baked into JWT â€” validated on every API request','Permissions enforced at API layer, not just UI','PBI RLS role mapped from tenantId + role at token generation'],tech:['JWT Claims','RBAC','Postgres RLS','Middleware'],techColor:'purple'},
  session:{tag:'Identity & Auth',title:'Session Management',desc:'Short-lived access tokens (15 min) and refresh tokens (7 days). Stored in httpOnly secure cookies â€” not localStorage â€” immune to XSS. Token rotation on every refresh.',points:['Access token: 15 min, RS256 signed JWT','Refresh token: 7 days, rotated on use','httpOnly, Secure, SameSite=Strict cookies','Silent refresh before expiry â€” no page reload needed'],tech:['httpOnly Cookies','JWT RS256','Refresh Token Rotation'],techColor:'purple'},
  gateway:{tag:'API Gateway',title:'API Gateway / BFF',desc:'Backend-For-Frontend layer between Next.js and backend services. Handles routing, rate limiting, and provides a clean surface for the frontend.',points:['Next.js API routes serve as the BFF â€” keeps it simple','Validates JWT on every request','Redis-backed per-tenant rate limits','Response shaping: transforms service responses into frontend shapes'],tech:['Next.js API Routes','JWT Validation','Redis Rate Limiting'],techColor:'amber'},
  middleware:{tag:'API Gateway',title:'Middleware Layer',desc:'Cross-cutting concerns on every request: tenant resolution, audit logging, security headers, CORS.',points:['Tenant resolution: extracts tenantId from JWT, validates active','Audit logging: every mutation logged with user, tenant, action, timestamp','Security headers via Helmet: HSTS, CSP, X-Frame-Options','CORS: whitelist per-tenant allowed origins'],tech:['Helmet.js','Next.js Middleware','Structured Logging'],techColor:'amber'},
  api:{tag:'Backend Services',title:'Core API (Deno 2)',desc:'Central business logic layer running on Deno 2. Handles all CRUD operations, tenant config, navigation menus, and report metadata. Native TypeScript, no build step.',points:['Fastify â€” faster than Express, excellent TypeScript support','Deno 2 runtime â€” native TS, deny-by-default security','Handles: user management, tenant config, navigation trees, page â†’ report mappings','All queries include tenantId filter enforced at ORM level','Zod input validation â€” rejects malformed requests before DB'],tech:['Deno 2','Fastify','Drizzle ORM','Zod','TypeScript'],techColor:'green'},
  'embed-service':{tag:'Backend Services',title:'Embed Token Service (Deno 2)',desc:'Most security-critical service, running on Deno 2 with minimal permissions. Generates Power BI embed tokens server-side using a service principal, injecting the correct RLS identity. Credentials never leave the server.',points:['Deno 2 runtime â€” runs with only --allow-net and --allow-env flags','Authenticates to PBI REST API using Service Principal','Resolves user â†’ tenant â†’ workspace â†’ report â†’ RLS role','Calls GenerateTokenInGroup with user\'s username for RLS','Returns 1-hour embed token â€” nothing more','Caches in Redis: pbi:embed:{tenantId}:{userId}:{reportId} (45min TTL)'],tech:['Deno 2','Power BI REST API','Service Principal','Redis Cache','Azure AD'],techColor:'green'},
  'tenant-service':{tag:'Backend Services',title:'Tenant Service (Deno 2)',desc:'Manages all tenant-specific config: branding, navigation menus, feature flags, report-to-page mappings. Replaces the Reporting Hub admin UI. Runs on Deno 2.',points:['Tenant CRUD: create tenants, configure branding','Navigation tree management: define page hierarchy per tenant','Report mapping: link pages to Power BI report IDs','Feature flags: enable/disable features per tenant','Cached in Redis â€” no DB hit on every page load'],tech:['Deno 2','PostgreSQL','Redis','Admin API','Feature Flags'],techColor:'green'},
  'ai-service':{tag:'Backend Services',title:'AI / Analytics Service (Deno 2)',desc:'Optional but high-value. Enables natural language querying, AI-generated insights, and intelligent summaries. Runs on Deno 2. Where we differentiate most from Reporting Hub.',points:['NL to data query: translate questions to safe, read-only, tenant-scoped SQL','AI-generated report summaries in plain text','Anomaly detection: flag unusual patterns','OpenAI GPT-4o or Anthropic Claude via API'],tech:['Deno 2','OpenAI API','Anthropic API','LangChain','Structured outputs'],techColor:'green'},
  postgres:{tag:'Data Layer',title:'PostgreSQL',desc:'Primary operational database. All application state: tenants, users, roles, config, audit logs. Postgres RLS enforces tenant isolation at the DB layer.',points:['All tables include tenantId foreign key','Postgres RLS policies as a safety net below app layer','AWS RDS Multi-AZ for high availability','Read replica for analytics/audit queries','PgBouncer connection pooling (transaction mode)'],tech:['PostgreSQL 16','Postgres RLS','PgBouncer','Drizzle ORM'],techColor:'amber'},
  redis:{tag:'Data Layer',title:'Redis',desc:'In-memory cache and session store. Embed token caching alone eliminates most Power BI REST API calls, which are slow (200â€“500ms).',points:['Embed token cache: 45min TTL, keyed by user+report+tenant','Tenant config cache: nav trees, branding','Rate limit counters: sliding window per tenant/user/endpoint'],tech:['Redis 7','ioredis','AWS ElastiCache'],techColor:'amber'},
  blob:{tag:'Data Layer',title:'Blob Storage',desc:'Object storage for assets that don\'t belong in the relational DB: tenant logos, exported reports.',points:['Tenant logos served via CloudFront CDN','Report exports stored temporarily with pre-signed URLs','Versioning enabled, SSE-S3 encryption'],tech:['S3','CloudFront CDN','Pre-signed URLs'],techColor:'amber'},
  observability:{tag:'Data Layer',title:'Observability Stack',desc:'Full visibility: structured logs, distributed traces, business metrics. Non-negotiable for production multi-tenant SaaS.',points:['Structured logging: every log line includes tenantId, userId, requestId','Distributed tracing: trace request from browser â†’ DB â†’ PBI API','Metrics: report load time, embed latency, auth failures, PBI capacity','Alerting: page on-call when error rate spikes or PBI hits 80% capacity'],tech:['DataDog','OpenTelemetry','Pino logger','CloudWatch'],techColor:'amber'},
  'pbi-service':{tag:'Power BI',title:'Power BI Embedded (A-SKU)',desc:'A-SKU for embedding in external-facing apps without end users needing PBI licences. Reserved capacity billed monthly.',points:['A1 SKU: ~$735/month, ~300 concurrent renders','Autoscale to A2/A3 for higher concurrency','One workspace per tenant recommended','RLS enforced entirely by Power BI â€” we pass identity via embed token'],tech:['Power BI A-SKU','Azure','PBI Workspaces'],techColor:'primary'},
  'pbi-api':{tag:'Power BI',title:'Power BI REST API',desc:'Used server-side only by Embed Token Service to generate tokens and manage reports. Never called from the browser.',points:['GenerateTokenInGroup: embed token with RLS identity','GetReports / GetDatasets: list available reports for admin UI','Dataset refresh: trigger scheduled data refreshes','Authenticated via Service Principal â€” not a user account'],tech:['Power BI REST API','Service Principal','MSAL','Azure AD'],techColor:'primary'},
  'pbi-rls':{tag:'Power BI',title:'Row-Level Security',desc:'PBI RLS restricts what data a user sees. Defined as DAX filters keyed on role + username. Our backend injects these into the embed token.',points:['RLS roles defined in PBI dataset (e.g. "TenantViewer")','DAX filter: [TenantId] = USERPRINCIPALNAME()','We pass: { roles: [{ name: "TenantViewer", username: "tenant-123" }] }','Power BI enforces the filter â€” users cannot see other tenants\' data','customData claim for more complex multi-dimension RLS scenarios'],tech:['DAX Filters','RLS Roles','Username claim','CustomData claim'],techColor:'primary'}
};

function showDetail(key){
  const d=details[key];if(!d)return;
  const tc=d.techColor||'primary';
  document.getElementById('detail-content').innerHTML=`
    <div class="detail-tag">${d.tag}</div>
    <div class="detail-title">${d.title}</div>
    <div class="detail-desc">${d.desc}</div>
    <div class="detail-section"><div class="detail-section-title">Key Points</div>${d.points.map(p=>`<div class="detail-item"><div class="detail-item-dot"></div><div class="detail-item-text">${p}</div></div>`).join('')}</div>
    <div class="detail-section"><div class="detail-section-title">Technologies</div><div class="detail-tech">${d.tech.map(t=>`<span class="tech-badge ${tc}">${t}</span>`).join('')}</div></div>`;
  document.getElementById('detail-panel').classList.add('open');
  document.getElementById('backdrop').classList.add('open');
}
function closeDetail(){document.getElementById('detail-panel').classList.remove('open');document.getElementById('backdrop').classList.remove('open');}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeDetail();});

// â”€â”€ COST CALCULATOR â”€â”€
let pbiSKU='A2', authProvider='auth0', aiEnabled=false, riEnabled=false, cloudProvider='aws', showingCompare=false;
const pbiCosts={A1:735,A2:1470,A3:2941};
const pbiDesc={A1:'~300 concurrent renders',A2:'~600 concurrent renders',A3:'~1,200 concurrent renders'};

function setPBI(s){pbiSKU=s;['A1','A2','A3'].forEach(k=>document.getElementById('opt-'+k.toLowerCase()).classList.toggle('active',k===s));recalc();}
function setAuth(p){authProvider=p;document.getElementById('opt-auth0').classList.toggle('active',p==='auth0');document.getElementById('opt-azuread').classList.toggle('active',p==='azuread');recalc();}
function setAI(on){aiEnabled=on;document.getElementById('opt-ai-off').classList.toggle('active',!on);document.getElementById('opt-ai-on').classList.toggle('active',on);recalc();}
function setRI(on){riEnabled=on;document.getElementById('opt-od').classList.toggle('active',!on);document.getElementById('opt-ri').classList.toggle('active',on);recalc();}
function setCloud(c){
  cloudProvider=c;
  document.getElementById('opt-cloud-aws').classList.toggle('active',c==='aws');
  document.getElementById('opt-cloud-azure').classList.toggle('active',c==='azure');
  document.getElementById('cloud-note').textContent=c==='azure'?'Azure App Service + Azure Cache for Redis + Azure Database for PostgreSQL':'ECS Fargate + ElastiCache + RDS PostgreSQL';
  recalc();
}
function toggleCompare(){
  showingCompare=!showingCompare;
  document.getElementById('compare-panel').style.display=showingCompare?'block':'none';
  document.getElementById('btn-compare').style.borderColor=showingCompare?'var(--accent5)':null;
  document.getElementById('btn-compare').style.color=showingCompare?'var(--accent5)':null;
  document.getElementById('btn-compare').textContent=showingCompare?'âœ• Hide Comparison':'â‡„ Compare Both';
  if(showingCompare)recalc();
}

function fmt(n){return'$'+Math.round(n).toLocaleString();}

function buildCosts(cloud, tenantsLaunch, tenantsScale, mau, concurrent, ri){
  const pbiL=pbiCosts[pbiSKU], pbiS=pbiCosts[pbiSKU];
  let authL,authS,authName;
  if(authProvider==='auth0'){
    authL=Math.max(0,(mau-7500)*0.0023);
    authS=Math.max(0,(mau*2-7500)*0.0023);
    authName='Auth0';
  } else {
    authL=Math.max(0,(mau-50000)*0.00016);
    authS=Math.max(0,(mau*2-50000)*0.00016);
    authName='Azure AD B2C';
  }
  const launchTaskCount=6, scaleTaskCount=Math.max(18,Math.ceil(concurrent/15)*3);
  let services;
  if(cloud==='aws'){
    const taskHr=(0.5*0.04856)+(1*0.00532);
    const fargateL=taskHr*launchTaskCount*730*ri;
    const fargateS=taskHr*scaleTaskCount*730*ri;
    const rdsL=67*2*ri;
    const rdsS=(tenantsScale>100?134:67)*2*ri;
    const redisL=13.9*2;
    const redisS=13.9*(concurrent>800?4:3);
    const cfL=10, cfS=Math.round(10+mau*0.005);
    const albL=18, albS=Math.round(16+concurrent*0.055);
    const wafL=12, wafS=Math.round(12+tenantsScale*0.15);
    services=[
      {icon:'ğŸŒ',name:'CloudFront CDN',desc:'Global edge caching',tier:'Managed',launch:cfL,scale:cfS},
      {icon:'ğŸ›¡ï¸',name:'AWS WAF',desc:'Web application firewall',tier:'Managed',launch:wafL,scale:wafS},
      {icon:'âš–ï¸',name:'ALB (Load Balancer)',desc:'Multi-AZ Â· SSL termination',tier:'Multi-AZ',launch:albL,scale:albS},
      {icon:'ğŸ¦•',name:'ECS Fargate (Deno)',desc:`${launchTaskCount} tasks â†’ ${scaleTaskCount} tasks`,tier:'Auto-scale',launch:fargateL,scale:fargateS},
      {icon:'ğŸ˜',name:'RDS PostgreSQL',desc:'db.t4g.medium Â· Multi-AZ',tier:'Multi-AZ',launch:rdsL,scale:rdsS},
      {icon:'âš¡',name:'ElastiCache Redis',desc:'cache.t4g.micro cluster',tier:'Clustered',launch:redisL,scale:redisS},
      {icon:'ğŸ—„ï¸',name:'S3 + Storage',desc:'Assets Â· exports Â· backups',tier:'Managed',launch:5,scale:Math.round(5+tenantsScale*0.15)},
      {icon:'ğŸ”’',name:'Secrets Manager',desc:'Credentials + API keys',tier:'Managed',launch:8,scale:12},
      {icon:'ğŸ“¡',name:'CloudWatch',desc:'Logs Â· metrics Â· alarms',tier:'Managed',launch:15,scale:Math.round(15+tenantsScale*0.5)},
      {icon:'ğŸŒ',name:'Route 53',desc:'DNS routing',tier:'Managed',launch:5,scale:5},
    ];
  } else {
    const appSvcHr=0.21*ri;
    const appSvcL=appSvcHr*4*730;
    const appSvcS=appSvcHr*Math.max(8,Math.ceil(concurrent/80))*730;
    const pgL=139*2*ri;
    const pgS=(tenantsScale>100?278:139)*2*ri;
    const redisAzL=134;
    const redisAzS=concurrent>800?268:134;
    const cdnL=35, cdnS=Math.round(35+mau*0.006);
    const agwL=30, agwS=Math.round(28+concurrent*0.04);
    const monL=20, monS=Math.round(20+tenantsScale*0.6);
    const kvL=6, kvS=10;
    const blobL=5, blobS=Math.round(5+tenantsScale*0.15);
    const dnsL=5, dnsS=5;
    services=[
      {icon:'ğŸŒ',name:'Azure Front Door (CDN)',desc:'Global edge Â· WAF included',tier:'Managed',launch:cdnL,scale:cdnS},
      {icon:'âš–ï¸',name:'App Gateway + WAF',desc:'Zone redundant Â· SSL',tier:'Zone-HA',launch:agwL,scale:agwS},
      {icon:'ğŸ¦•',name:'App Service (P2v3, Deno)',desc:`${4} instances â†’ ${Math.max(8,Math.ceil(concurrent/80))} instances`,tier:'Auto-scale',launch:appSvcL,scale:appSvcS},
      {icon:'ğŸ˜',name:'Azure DB PostgreSQL',desc:'Flexible Â· Zone redundant',tier:'Zone-HA',launch:pgL,scale:pgS},
      {icon:'âš¡',name:'Azure Cache for Redis',desc:'C2 standard cluster',tier:'Clustered',launch:redisAzL,scale:redisAzS},
      {icon:'ğŸ—„ï¸',name:'Blob Storage',desc:'Assets Â· exports Â· backups',tier:'Managed',launch:blobL,scale:blobS},
      {icon:'ğŸ”’',name:'Azure Key Vault',desc:'Secrets + certificates',tier:'Managed',launch:kvL,scale:kvS},
      {icon:'ğŸ“¡',name:'Azure Monitor',desc:'Logs Â· metrics Â· alerts',tier:'Managed',launch:monL,scale:monS},
      {icon:'ğŸŒ',name:'Azure DNS',desc:'DNS zones routing',tier:'Managed',launch:dnsL,scale:dnsS},
    ];
  }
  services.push({icon:'ğŸ“Š',name:`Power BI Embedded (${pbiSKU})`,desc:pbiDesc[pbiSKU],tier:'Azure',launch:pbiL,scale:pbiS});
  services.push({icon:'ğŸ”',name:authName,desc:`${mau.toLocaleString()} â†’ ${(mau*2).toLocaleString()} MAU`,tier:'SaaS',launch:authL,scale:authS});
  if(aiEnabled){services.push({icon:'ğŸ¤–',name:'AI API (OpenAI/Anthropic)',desc:`~${mau.toLocaleString()} users`,tier:'SaaS',launch:mau*0.025,scale:mau*0.06});}
  return services;
}

function recalc(){
  const tenantsLaunch=parseInt(document.getElementById('sl-tenants-launch').value);
  const tenantsScale=parseInt(document.getElementById('sl-tenants-scale').value);
  const mau=parseInt(document.getElementById('sl-mau').value);
  const concurrent=parseInt(document.getElementById('sl-concurrent').value);
  document.getElementById('lbl-tenants-launch').textContent=tenantsLaunch;
  document.getElementById('lbl-tenants-scale').textContent=tenantsScale;
  document.getElementById('lbl-mau').textContent=mau.toLocaleString();
  document.getElementById('lbl-concurrent').textContent=concurrent;
  const ri=riEnabled?0.65:1.0;
  const skuWarnings={A1:'âš ï¸ A1 only handles ~300 concurrent â€” may be insufficient at your peak.',A2:'âœ“ A2 handles ~600 concurrent â€” good for mid-range peaks.',A3:'âœ“ A3 handles ~1,200 concurrent â€” good for your upper scale estimate.'};
  document.getElementById('pbi-sku-hint').textContent=skuWarnings[pbiSKU]||'';
  const authNote=authProvider==='auth0'
    ?`Auth0 free tier: 7,500 MAU. Your ${mau.toLocaleString()} MAU = ${mau<=7500?'within free tier âœ“':'paid tier, ~'+fmt((mau-7500)*0.0023)+'/mo'}`
    :`Azure AD B2C: 50,000 MAU free. Your ${mau.toLocaleString()} MAU = ${mau<=50000?'within free tier âœ“':'paid tier, ~'+fmt((mau-50000)*0.00016)+'/mo'}`;
  document.getElementById('auth-note').textContent=authNote;
  const services=buildCosts(cloudProvider,tenantsLaunch,tenantsScale,mau,concurrent,ri);
  const totalLaunch=services.reduce((s,r)=>s+r.launch,0);
  const totalScale=services.reduce((s,r)=>s+r.scale,0);
  const maxVal=Math.max(...services.map(r=>r.scale),1);
  document.getElementById('breakdown-rows').innerHTML=services.map(r=>`
    <div class="breakdown-row">
      <div class="br-service"><div class="br-icon">${r.icon}</div><div><div class="br-name">${r.name}</div><div class="br-desc">${r.desc}</div></div></div>
      <div class="br-tier">${r.tier}</div>
      <div class="br-launch">${fmt(r.launch)}</div>
      <div class="br-scale">${fmt(r.scale)}</div>
      <div><div class="br-bar-inner" style="width:${Math.round(r.scale/maxVal*100)}%;background:${r.name.includes('Power BI')?'var(--accent4)':r.tier==='SaaS'?'var(--accent2)':'var(--accent)'}"></div></div>
    </div>`).join('');
  document.getElementById('footer-launch').textContent=fmt(totalLaunch);
  document.getElementById('footer-scale').textContent=fmt(totalScale);
  document.getElementById('stat-launch').textContent=fmt(totalLaunch);
  document.getElementById('stat-scale').textContent=fmt(totalScale);
  document.getElementById('stat-annual').textContent=fmt(totalLaunch*6+totalScale*6);
  document.getElementById('stat-launch-sub').textContent=`~${tenantsLaunch} tenants`;
  document.getElementById('stat-scale-sub').textContent=`~${tenantsScale} tenants`;
  const pbiPct=Math.round((pbiCosts[pbiSKU]/totalScale)*100);
  const riSaving=riEnabled?0:Math.round(totalScale*0.12);
  document.getElementById('insight-box').innerHTML=`
    <div style="font-size:11px;font-weight:600;color:var(--accent4);margin-bottom:6px;">ğŸ’¡ Key insight</div>
    <div style="font-size:11px;color:var(--text-dim);line-height:1.6;">
      Power BI ${pbiSKU} is <strong style="color:var(--text)">${pbiPct}% of your monthly cost</strong> at scale.
      ${!riEnabled?`Switching to Reserved Instances would save ~${fmt(riSaving)}/mo on compute.`:'Reserved Instances applied â€” ~35% saving on compute.'}
      ${pbiSKU==='A1'&&concurrent>300?'<span style="color:var(--accent5)"> âš ï¸ Consider upgrading to A2 â€” your concurrent load may exceed A1 capacity.</span>':''}
    </div>`;
  const pbiVal=pbiCosts[pbiSKU];
  const computeVal=services.filter(s=>s.name.includes('Fargate')||s.name.includes('App Service')).reduce((a,s)=>a+s.scale,0);
  const dataVal=services.filter(s=>s.name.includes('PostgreSQL')||s.name.includes('Redis')).reduce((a,s)=>a+s.scale,0);
  const authVal=services.find(s=>s.name.includes('Auth'))?.scale||0;
  const otherVal=totalScale-pbiVal-computeVal-dataVal-authVal;
  const categories=[
    {label:'Power BI',val:pbiVal,color:'var(--accent4)'},
    {label:'Compute',val:computeVal,color:'var(--accent)'},
    {label:'Database',val:dataVal,color:'#f472b6'},
    {label:'Auth',val:authVal,color:'var(--accent2)'},
    {label:'Other',val:Math.max(0,otherVal),color:'var(--text-muted)'},
  ];
  document.getElementById('pbi-warning').style.display='block';
  document.getElementById('cost-bar-chart').innerHTML=categories.map(c=>`
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:7px;">
      <div style="width:70px;font-size:10px;color:var(--text-muted);text-align:right;font-family:'IBM Plex Mono',monospace;">${c.label}</div>
      <div style="flex:1;height:16px;background:var(--surface2);border-radius:3px;overflow:hidden;">
        <div style="width:${Math.round(c.val/totalScale*100)}%;height:100%;background:${c.color};border-radius:3px;transition:width 0.4s ease;"></div>
      </div>
      <div style="width:55px;font-size:11px;color:var(--text-dim);font-family:'IBM Plex Mono',monospace;">${fmt(c.val)} <span style="color:var(--text-muted);font-size:9px;">${Math.round(c.val/totalScale*100)}%</span></div>
    </div>`).join('');
  if(showingCompare){
    ['aws','azure'].forEach(cloud=>{
      const s=buildCosts(cloud,tenantsLaunch,tenantsScale,mau,concurrent,ri);
      const tL=s.reduce((a,r)=>a+r.launch,0);
      const tS=s.reduce((a,r)=>a+r.scale,0);
      document.getElementById('compare-'+cloud).innerHTML=`
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
          <div style="text-align:center;padding:10px;background:var(--surface2);border-radius:6px;">
            <div style="font-size:10px;color:var(--text-muted);margin-bottom:4px;">Launch /mo</div>
            <div style="font-size:20px;font-weight:700;font-family:'IBM Plex Mono',monospace;">${fmt(tL)}</div>
          </div>
          <div style="text-align:center;padding:10px;background:var(--surface2);border-radius:6px;">
            <div style="font-size:10px;color:var(--text-muted);margin-bottom:4px;">Scale /mo</div>
            <div style="font-size:20px;font-weight:700;font-family:'IBM Plex Mono',monospace;color:var(--accent4);">${fmt(tS)}</div>
          </div>
        </div>
        ${s.slice(0,5).map(r=>`<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border);font-size:11px;"><span style="color:var(--text-dim)">${r.icon} ${r.name}</span><span style="font-family:'IBM Plex Mono',monospace;color:var(--text)">${fmt(r.scale)}</span></div>`).join('')}
        <div style="font-size:10px;color:var(--text-muted);margin-top:6px;">+ ${s.length-5} more servicesâ€¦</div>`;
    });
    const awsS=buildCosts('aws',tenantsLaunch,tenantsScale,mau,concurrent,ri).reduce((a,r)=>a+r.scale,0);
    const azureS=buildCosts('azure',tenantsLaunch,tenantsScale,mau,concurrent,ri).reduce((a,r)=>a+r.scale,0);
    const diff=Math.abs(awsS-azureS);
    const cheaper=awsS<azureS?'AWS':'Azure';
    document.getElementById('compare-verdict').innerHTML=`
      <strong style="color:var(--text)">${cheaper} is ~${fmt(diff)}/mo cheaper at scale</strong> for your parameters (~${Math.round(diff/Math.max(awsS,azureS)*100)}% difference). 
      ${cheaper==='AWS'?'AWS wins on Fargate flexibility and granular auto-scaling at this concurrency level.':'Azure wins if you consolidate on Microsoft stack â€” Power BI, Azure AD B2C, and App Service in one ecosystem reduces operational overhead.'} 
      <strong style="color:var(--accent)">Recommendation:</strong> If your team has stronger AWS experience, go AWS. If you're already buying Azure services or want to simplify the Power BI billing relationship, Azure is a clean choice.`;
  }
}

document.getElementById('cloud-note').textContent='ECS Fargate + ElastiCache + RDS PostgreSQL';
recalc();
</script>
</body>
</html>
